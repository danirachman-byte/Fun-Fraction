<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pecahan Pintar</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        
        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; font-family: 'Nunito', sans-serif; 
            height: 100%; width: 100%; background-color: #f0f7ff; overflow: hidden;
        }

        .screen { display: none; width: 100%; height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        .screen.active { display: flex; }

        .card { 
            background: white; padding: 40px; border-radius: 30px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; 
            width: 90%; max-width: 400px; 
        }

        h1 { color: #004a99; margin-bottom: 20px; }
        input { 
            width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #e0e0e0; 
            border-radius: 15px; font-size: 16px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: #007bff; }

        .btn-blue { 
            background: #007bff; color: white; border: none; padding: 15px; 
            width: 100%; border-radius: 15px; font-size: 18px; font-weight: bold; 
            cursor: pointer; margin-top: 10px; transition: 0.3s;
        }
        .btn-blue:hover { background: #0056b3; transform: translateY(-2px); }

        .menu-container { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 20px; width: 90%; max-width: 800px; 
        }
        .menu-item { 
            background: white; padding: 30px; border-radius: 25px; text-align: center; 
            cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.05); transition: 0.3s; border: 4px solid transparent;
        }
        .menu-item:hover { border-color: #007bff; transform: translateY(-5px); }
        .menu-item .icon { font-size: 50px; display: block; margin-bottom: 10px; }
        .menu-item span { font-weight: 800; color: #333; font-size: 18px; }

        #app-viewer { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: white; z-index: 9999; 
        }
        iframe { width: 100%; height: 100%; border: none; }
        .btn-home { 
            position: absolute; top: 15px; right: 15px; background: #ff4757; 
            color: white; border: none; padding: 12px 20px; border-radius: 12px; 
            font-weight: bold; cursor: pointer; z-index: 10000; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Menyembunyikan tempat penyimpanan kode */
        .raw-storage { display: none; }
    </style>
</head>
<body>

    <div id="app-viewer">
        <button class="btn-home" onclick="closeApp()">üè† Home</button>
        <iframe id="app-frame"></iframe>
    </div>

    <!-- 1. LOGIN -->
    <div id="screen-login" class="screen active">
        <div class="card">
            <h1>Pecahan Pintar</h1>
            <p>Silakan login untuk memulai</p>
            <input type="text" id="user-name" placeholder="Nama Lengkap">
            <input type="text" id="user-token" placeholder="Token (6 Karakter)" maxlength="6">
            <button class="btn-blue" onclick="handleLogin()">MASUK</button>
        </div>
    </div>

    <!-- 2. MENU UTAMA -->
    <div id="screen-menu" class="screen">
        <h1>Pilih Aktivitas</h1>
        <div class="menu-container">
            <div class="menu-item" onclick="showDashboardScreen('screen-belajar')">
                <span class="icon">üìö</span>
                <span>Belajar</span>
            </div>
            <div class="menu-item" onclick="openApp('storage-app-4')">
                <span class="icon">üìù</span>
                <span>Latihan</span>
            </div>
            <div class="menu-item" onclick="openApp('storage-app-5')">
                <span class="icon">üéÆ</span>
                <span>Permainan</span>
            </div>
        </div>
    </div>

    <!-- 3. SUB MENU BELAJAR -->
    <div id="screen-belajar" class="screen">
        <h1>Materi Belajar</h1>
        <div class="menu-container">
            <div class="menu-item" onclick="openApp('storage-app-1')">
                <span class="icon">üçï</span>
                <span>Konsep Pecahan</span>
            </div>
            <div class="menu-item" onclick="openApp('storage-app-2')">
                <span class="icon">üç∞</span>
                <span>Pecahan Senilai</span>
            </div>
            <div class="menu-item" onclick="openApp('storage-app-3')">
                <span class="icon">‚öñÔ∏è</span>
                <span>Perbandingan</span>
            </div>
        </div>
        <button class="btn-blue" style="max-width: 200px; background: #6c757d; margin-top: 30px;" onclick="showDashboardScreen('screen-menu')">Kembali</button>
    </div>

    <!-- TEMPAT PENYIMPANAN KODE (GUNAKAN TEXTAREA) -->
    <textarea id="storage-app-1" class="raw-storage"><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pecahan Pintar - Konsep Pecahan Biasa</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');

        :root {
            --primary-color: #007bff; --dark-blue: #004a99; --light-blue: #f0f7ff;
            --text-color: #333; --base-gray: #e0e0e0; 
            /* Warna untuk Pizza/Kue mode Solid jika gambar gagal load, atau untuk overlay */
            --selected-yellow: #ffca28; 
            
            --anim-num-highlight: #ff5722;
            --anim-den-highlight: #007bff;
            --success-green: #28a745; --danger-red: #dc3545;
        }

        body {
            font-family: 'Nunito', sans-serif; background-color: var(--light-blue);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; color: var(--text-color);
            overflow-x: hidden; touch-action: none;
        }

        .app-container {
            background-color: #ffffff; padding: 25px; border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0, 80, 150, 0.15); 
            width: 95%; max-width: 1200px;
        }

        h1 { color: var(--dark-blue); font-weight: 800; margin-top: 0; text-align: center; }

        .app-body { display: flex; gap: 25px; }
        
        .controls-panel { 
            width: 260px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; 
            background: #f8f9fa; padding: 15px; border-radius: 20px; border: 1px solid #eee;
        }
        
        .right-panel { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        
        /* HEADER KANAN */
        .visuals-header {
            display: flex; justify-content: space-between; 
            align-items: center; padding-bottom: 5px;
        }
        
        .shape-selector-group {
            display: flex; gap: 10px; background: #fff; padding: 5px; border-radius: 15px; border: 1px solid #eee;
        }
        
        .shape-btn {
            width: 50px; height: 50px; border: 2px solid #ddd;
            background: white; cursor: pointer; display: flex; justify-content: center;
            align-items: center; transition: all 0.2s; overflow: hidden; padding: 0;
        }
        .shape-btn:hover { border-color: var(--primary-color); transform: translateY(-2px); }
        .shape-btn.active { border-color: var(--primary-color); background-color: #e6f2ff; box-shadow: 0 0 10px rgba(0,123,255,0.3); }
        
        .btn-round { border-radius: 50%; }
        .btn-square { border-radius: 12px; }
        
        .shape-icon-img { width: 100%; height: 100%; object-fit: cover; }
        .shape-icon-svg { width: 30px; height: 30px; fill: var(--dark-blue); }

        .restart-btn {
            width: 45px; height: 45px; border-radius: 50%; 
            border: 2px solid #ddd; background: white; color: #666;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        .restart-btn:hover { 
            background-color: #fff0f0; border-color: var(--danger-red); 
            color: var(--danger-red); transform: rotate(-90deg); 
        }
        .restart-btn svg { width: 22px; height: 22px; fill: currentColor; }

        .mode-switcher {
            display: flex; justify-content: center; background-color: #e9ecef;
            border-radius: 30px; padding: 5px; margin-bottom: 10px;
        }
        .mode-btn {
            flex: 1; padding: 10px 5px; border: none; background-color: transparent;
            color: #6c757d; font-size: 0.85em; font-weight: 700;
            border-radius: 25px; cursor: pointer; transition: all 0.3s ease;
        }
        .mode-btn.active { background-color: var(--primary-color); color: white; box-shadow: 0 2px 10px rgba(0, 123, 255, 0.4); }

        .hidden { display: none !important; }

        /* --- VISUALS AREA --- */
        .visuals-area {
            min-height: 450px; 
            padding: 20px;
            border: 2px dashed #ddd; border-radius: 20px; 
            background: #fdfdfd; 
            position: relative; flex-grow: 1;
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; align-content: center;
            gap: 15px;
            z-index: 0; 
        }

        .visuals-area.grid-layout { display: grid; justify-items: center; align-items: center; }

        .shape-container { 
            width: 150px; height: 150px; 
            display: flex; justify-content: center; align-items: center; 
            position: relative; 
            z-index: 1; 
            transition: transform 0.3s;
        }

        .shape-container.popup-focus {
            z-index: 9999 !important; 
            transform: scale(1.15) !important;
            filter: drop-shadow(0 25px 50px rgba(0,0,0,0.3));
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            pointer-events: none; 
        }

        /* Responsive Size Logic */
        .visuals-area[data-count="1"] .shape-container { width: 380px; height: 380px; }
        .visuals-area[data-count="2"] .shape-container { width: 280px; height: 280px; }
        .visuals-area[data-count="3"] .shape-container,
        .visuals-area[data-count="4"] .shape-container { width: 200px; height: 200px; }
        .visuals-area[data-count="5"] .shape-container,
        .visuals-area[data-count="6"] .shape-container { width: 170px; height: 170px; }
        .visuals-area[data-count="7"] .shape-container,
        .visuals-area[data-count="8"] .shape-container { width: 150px; height: 150px; }
        .visuals-area[data-count="9"] .shape-container,
        .visuals-area[data-count="10"] .shape-container { width: 140px; height: 140px; }

        .shape-svg { 
            width: 100%; height: 100%; overflow: visible; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); 
        }

        /* Image Masking Styles */
        .slice-image { transition: opacity 0.3s; }
        .hit-area { 
            fill: transparent; stroke: rgba(255,255,255,0.5); stroke-width: 1px;
            cursor: pointer; transition: stroke 0.2s;
        }
        .hit-area:hover { stroke: #fff; stroke-width: 3px; }

        .floating-count {
            position: absolute; font-size: 2.5em; font-weight: 900;
            color: var(--anim-den-highlight);
            text-shadow: 3px 3px 0px white, -3px -3px 0px white, 3px -3px 0px white, -3px 3px 0px white;
            z-index: 10000; pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
        }
        .floating-count.numerator-mode { color: var(--anim-num-highlight); }
        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            40% { opacity: 1; transform: translate(-50%, -80%) scale(1.5); }
            100% { opacity: 0; transform: translate(-50%, -130%) scale(1); }
        }

        .input-box.highlight-denom { border-color: var(--anim-den-highlight); background-color: #e6f2ff; box-shadow: 0 0 15px rgba(0,123,255,0.4); }
        .input-box.highlight-num { border-color: var(--anim-num-highlight); background-color: #ffccbc; box-shadow: 0 0 15px rgba(255,87,34,0.4); }

        .anim-appear-denom { stroke: var(--anim-den-highlight) !important; stroke-width: 3px !important; filter: brightness(1.2); }
        
        body.is-animating * { pointer-events: none !important; cursor: wait !important; }

        .play-btn {
            width: 100%; height: 60px; border-radius: 15px; border: none; font-size: 2em;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            background-color: var(--success-green); color: white; transition: background-color 0.2s; margin-top: 15px;
        }
        .play-btn:hover { background-color: #218838; }
        .play-btn:disabled { background-color: #aaa; cursor: not-allowed; }

        .generator-controls { text-align: center; margin-bottom: 15px; }
        .generator-btn-container { display: flex; justify-content: space-around; margin-bottom: 10px; }
        .generator-btn {
            width: 50px; height: 50px; border-radius: 50%; border: 3px solid #ddd; font-size: 2em;
            font-weight: bold; display: flex; justify-content: center; align-items: center;
            cursor: pointer; background-color: #fff; user-select: none;
        }
        
        .slider-container label { font-weight: bold; font-size: 0.9em; }

        .fraction-input-area { display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 15px; }
        .input-box {
            padding: 5px; border: 2px solid #ccc; border-radius: 10px; cursor: pointer;
            text-align: center; transition: all 0.2s ease; min-height: 40px; background: white;
        }
        .input-box.active { border-color: var(--primary-color); box-shadow: 0 0 10px rgba(0,123,255,0.3); }
        .input-fraction { display: flex; flex-direction: column; align-items: center;}
        .input-numerator, .input-denominator { font-size: 1.8em; width: 60px; }
        .fraction-line { height: 3px; background-color: #333; margin: 2px 0; width: 50px; }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .numpad-btn {
            padding: 10px; font-size: 1.1em; font-weight: 700; border-radius: 10px;
            border: 1px solid #ddd; background-color: #fff; cursor: pointer;
        }
        .numpad-btn.clear { grid-column: 2 / span 2; background-color: var(--danger-red); color: white; }

        .result-area {
            height: 90px; display: flex; flex-direction: column; justify-content: center;
            align-items: center; position: relative; margin-top: 20px;
            background: white; border-radius: 15px; padding: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .final-fraction {
            display: flex; align-items: center; gap: 10px; visibility: hidden;
            opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: scale(0.8);
        }
        .final-fraction.visible { visibility: visible; opacity: 1; transform: scale(1); }
        .final-fraction-part { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .final-num, .final-den { font-size: 2.5em; font-weight: 800; transition: transform 0.2s; }
        .final-num.pop { transform: scale(1.5); color: var(--anim-num-highlight); }
        .final-den.pop { transform: scale(1.5); color: var(--anim-den-highlight); }
        .final-line { height: 4px; width: 60px; background-color: var(--text-color); margin: 5px 0; }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .alert-box {
            background: white; padding: 25px 40px; border-radius: 15px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .alert-box button {
            margin-top: 15px; padding: 10px 25px; border-radius: 8px; border: none;
            background-color: var(--primary-color); color: white; font-size: 1em;
            font-weight: bold; cursor: pointer;
        }
        
        @media (max-width: 768px) { 
            .app-body { flex-direction: column; } 
            .controls-panel { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <h1>Konsep Pecahan Biasa</h1>
        <div class="app-body">
            <!-- PANEL KIRI -->
            <div class="controls-panel">
                <div class="mode-switcher">
                    <button class="mode-btn active" data-mode="picture">Buat dari Gambar</button>
                    <button class="mode-btn" data-mode="number">Buat dari Bilangan</button>
                </div>

                <div id="picture-mode-controls">
                    <div class="generator-controls">
                        <div class="generator-btn-container">
                           <div id="add-btn" class="generator-btn">+</div>
                           <div id="remove-btn" class="generator-btn">-</div>
                        </div>
                        <div class="slider-container" id="slider-wrapper">
                           <label for="parts-slider">Potongan per Bangun: <span id="slider-value">4</span></label><br>
                           <input type="range" id="parts-slider" min="2" max="24" value="4" style="width: 200px;">
                        </div>
                    </div>
                    <button id="play-btn-pic" class="play-btn">&#9654;</button>
                </div>
                
                <div id="number-mode-controls" class="hidden">
                     <div class="fraction-input-area">
                        <div class="input-fraction">
                            <div id="input-numerator" class="input-box input-numerator">?</div>
                            <div class="fraction-line"></div>
                            <div id="input-denominator" class="input-box input-denominator">?</div>
                        </div>
                    </div>
                    <div class="numpad">
                        <button class="numpad-btn" data-num="1">1</button><button class="numpad-btn" data-num="2">2</button>
                        <button class="numpad-btn" data-num="3">3</button><button class="numpad-btn" data-num="4">4</button>
                        <button class="numpad-btn" data-num="5">5</button><button class="numpad-btn" data-num="6">6</button>
                        <button class="numpad-btn" data-num="7">7</button><button class="numpad-btn" data-num="8">8</button>
                        <button class="numpad-btn" data-num="9">9</button><button class="numpad-btn" data-num="0">0</button>
                        <button id="clear-btn" class="numpad-btn clear">Hapus</button>
                    </div>
                    <button id="play-btn-num" class="play-btn" disabled>&#9654;</button>
                </div>

                <div class="result-area">
                    <div id="final-fraction" class="final-fraction">
                        <div class="final-fraction-part">
                            <span id="final-num" class="final-num"></span>
                            <div class="final-line"></div>
                            <span id="final-den" class="final-den"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PANEL KANAN -->
            <div class="right-panel">
                <div class="visuals-header">
                    <!-- Restart -->
                    <button id="visual-restart-btn" class="restart-btn" title="Mulai Ulang">
                        <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    </button>

                    <!-- Shape Selector (4 Pilihan) -->
                    <div class="shape-selector-group">
                        <button class="shape-btn btn-round active" data-shape="pizza" title="Pizza">
                            <img src="https://lh3.googleusercontent.com/d/16UcjLvdl2N7DYerPSSzh4QqUa3nl-oAC" class="shape-icon-img">
                        </button>
                        <button class="shape-btn btn-square" data-shape="cake" title="Kue">
                            <img src="https://lh3.googleusercontent.com/d/1MAanQClTP84BOfsgufk32kjGOQjzKyso" class="shape-icon-img">
                        </button>
                        <button class="shape-btn btn-round" data-shape="circle_plain" title="Lingkaran Polos">
                            <svg class="shape-icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
                        </button>
                        <button class="shape-btn btn-square" data-shape="square_plain" title="Persegi Polos">
                            <svg class="shape-icon-svg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Area Visual Utama -->
                <div id="visuals-area" class="visuals-area" data-count="1"></div>
            </div>
        </div>
    </div>

    <div id="alert-overlay" class="overlay hidden">
        <div class="alert-box">
            <h3 id="alert-title">Peringatan</h3><p id="alert-message"></p>
            <button id="alert-close-btn">Mengerti</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                mode: 'picture', shape: 'pizza', // Default Shape = Pizza
                items: [], 
                partsPerShape: 4, 
                activeInput: 'numerator',
                input: { numerator: '', denominator: '' },
            };

            const IMG_URLS = {
                pizza: "https://lh3.googleusercontent.com/d/16UcjLvdl2N7DYerPSSzh4QqUa3nl-oAC", // Pizza 1
                cake:  "https://lh3.googleusercontent.com/d/1MAanQClTP84BOfsgufk32kjGOQjzKyso"   // Kue 1
            };

            const dom = {
                modeBtns: document.querySelectorAll('.mode-btn'), shapeBtns: document.querySelectorAll('.shape-btn'),
                picControls: document.getElementById('picture-mode-controls'),
                numControls: document.getElementById('number-mode-controls'), 
                visualsArea: document.getElementById('visuals-area'),
                restartBtn: document.getElementById('visual-restart-btn'),
                addBtn: document.getElementById('add-btn'), removeBtn: document.getElementById('remove-btn'), 
                sliderWrapper: document.getElementById('slider-wrapper'),
                slider: document.getElementById('parts-slider'),
                sliderValue: document.getElementById('slider-value'), 
                playBtnPic: document.getElementById('play-btn-pic'),
                playBtnNum: document.getElementById('play-btn-num'), 
                finalFraction: document.getElementById('final-fraction'), 
                finalNum: document.getElementById('final-num'), finalDen: document.getElementById('final-den'),
                inputBoxes: { numerator: document.getElementById('input-numerator'), denominator: document.getElementById('input-denominator') },
                numpadBtns: document.querySelectorAll('.numpad-btn'), clearBtn: document.getElementById('clear-btn'),
                alertOverlay: document.getElementById('alert-overlay'),
                alertMessage: document.getElementById('alert-message'), alertCloseBtn: document.getElementById('alert-close-btn'),
            };

            const ANIM_SPEED = 800; 

            function init() {
                addNewShapeItem();
                render();
            }

            function switchMode(newMode) {
                state.mode = newMode;
                dom.modeBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === newMode));
                dom.picControls.classList.toggle('hidden', newMode !== 'picture');
                dom.numControls.classList.toggle('hidden', newMode !== 'number');
                resetState();
            }

            function switchShape(e) {
                const btn = e.currentTarget;
                const newShape = btn.dataset.shape;
                state.shape = newShape;
                
                dom.shapeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                render();
            }

            function resetState() {
                state.items = [];
                state.input = { numerator: '', denominator: '' };
                dom.finalFraction.classList.remove('visible');
                dom.inputBoxes.denominator.classList.remove('highlight-denom');
                dom.inputBoxes.numerator.classList.remove('highlight-num');
                
                dom.visualsArea.innerHTML = '';

                if(state.mode === 'picture') {
                    addNewShapeItem();
                    render();
                } else {
                    setActiveInput('numerator');
                    renderVisuals(); 
                }
            }

            function addNewShapeItem() {
                const parts = Array(state.partsPerShape).fill(false);
                state.items.push({ selections: parts });
            }

            function handleAddButton() {
                if (state.items.length < 10) addNewShapeItem(); else showAlert("Maksimal 10 bangun.");
                render();
            }

            function handleRemoveButton() {
                if (state.items.length > 0) state.items.pop();
                render();
            }

            function handleSlider(e) {
                state.partsPerShape = parseInt(e.target.value); 
                dom.sliderValue.textContent = state.partsPerShape;
                state.items.forEach(item => {
                    const newSelections = Array(state.partsPerShape).fill(false);
                    for(let i=0; i<Math.min(item.selections.length, state.partsPerShape); i++){
                        newSelections[i] = item.selections[i];
                    }
                    item.selections = newSelections;
                });
                render();
            }

            function toggleSelection(itemIndex, partIndex) {
                if(state.items[itemIndex]) {
                    state.items[itemIndex].selections[partIndex] = !state.items[itemIndex].selections[partIndex];
                    render();
                }
            }

            function render() {
                if (state.mode === 'picture') renderVisuals(); else updateInputDisplays();
                checkNumPlayButton();
            }

            // --- RENDERER UTAMA (IMAGE + PLAIN) ---
            function renderVisuals() {
                dom.visualsArea.innerHTML = '';
                const count = state.items.length;
                dom.visualsArea.setAttribute('data-count', count);

                dom.visualsArea.classList.remove('grid-layout');
                dom.visualsArea.style.gridTemplateColumns = '';
                dom.visualsArea.style.gridTemplateRows = '';

                if (count > 0 && count % 2 === 0) {
                    dom.visualsArea.classList.add('grid-layout');
                    const cols = count / 2; 
                    dom.visualsArea.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                    dom.visualsArea.style.gridTemplateRows = `1fr 1fr`;
                }

                const svgNS = "http://www.w3.org/2000/svg";
                const isCircleGeometry = (state.shape === 'pizza' || state.shape === 'circle_plain');
                const isImageMode = (state.shape === 'pizza' || state.shape === 'cake');
                
                // Get Image URL if needed
                let imgUrl = "";
                if(state.shape === 'pizza') imgUrl = IMG_URLS.pizza;
                if(state.shape === 'cake') imgUrl = IMG_URLS.cake;

                state.items.forEach((item, itemIndex) => {
                    const div = document.createElement('div');
                    div.className = 'shape-container';
                    
                    const svg = document.createElementNS(svgNS, 'svg');
                    svg.setAttribute('viewBox', '0 0 100 100');
                    svg.classList.add('shape-svg');

                    const defs = document.createElementNS(svgNS, 'defs');
                    svg.appendChild(defs);

                    for (let i = 0; i < state.partsPerShape; i++) {
                        // 1. Path Data
                        let pathD = "";
                        if (isCircleGeometry) {
                            pathD = getPolarPath(50, 50, 48, (360/state.partsPerShape)*i, (360/state.partsPerShape)*(i+1));
                        } else {
                            const w = 100/state.partsPerShape;
                            const x = i * w;
                            pathD = `M ${x},0 L ${x+w},0 L ${x+w},100 L ${x},100 Z`;
                        }

                        const g = document.createElementNS(svgNS, 'g');

                        if (isImageMode) {
                            // --- MODE GAMBAR ---
                            const clipId = `clip-${itemIndex}-${i}-${Date.now()}`;
                            const clipPath = document.createElementNS(svgNS, 'clipPath');
                            clipPath.setAttribute('id', clipId);
                            const pathShape = document.createElementNS(svgNS, 'path');
                            pathShape.setAttribute('d', pathD);
                            clipPath.appendChild(pathShape);
                            defs.appendChild(clipPath);

                            const img = document.createElementNS(svgNS, 'image');
                            img.setAttribute('href', imgUrl);
                            
                            // Adjust Positioning
                            if (state.shape === 'pizza') {
                                img.setAttribute('x', '0'); img.setAttribute('y', '-7'); 
                                img.setAttribute('width', '100'); img.setAttribute('height', '115');
                            } else {
                                img.setAttribute('width', '100'); img.setAttribute('height', '100');
                                img.setAttribute('preserveAspectRatio', 'none'); 
                            }
                            
                            img.setAttribute('clip-path', `url(#${clipId})`);
                            img.classList.add('slice-image');

                            // State Visual
                            if (item.selections[i]) {
                                img.style.opacity = "1";
                                img.style.filter = "drop-shadow(0 0 1px rgba(0,0,0,0.5))";
                            } else {
                                img.style.opacity = "0.2"; 
                                img.style.filter = "grayscale(100%)";
                            }
                            g.appendChild(img);

                        } else {
                            // --- MODE POLOS ---
                            const path = document.createElementNS(svgNS, 'path');
                            path.setAttribute('d', pathD);
                            path.setAttribute('fill', item.selections[i] ? 'var(--selected-yellow)' : '#eee');
                            path.setAttribute('stroke', '#fff'); path.setAttribute('stroke-width', '1');
                            g.appendChild(path);
                        }

                        // 3. Hit Area (Transparent on Top)
                        const hitPath = document.createElementNS(svgNS, 'path');
                        hitPath.setAttribute('d', pathD);
                        hitPath.classList.add('interactive-part', 'hit-area');
                        if (!isImageMode) hitPath.setAttribute('stroke', 'transparent'); // Hide stroke in plain mode for cleaner look
                        
                        // Metadata for Animation
                        hitPath.dataset.selected = item.selections[i];
                        
                        // Click Handler
                        if(state.mode === 'picture') {
                            hitPath.onclick = () => toggleSelection(itemIndex, i);
                        }

                        g.appendChild(hitPath);
                        svg.appendChild(g);
                    }
                    
                    div.appendChild(svg);
                    dom.visualsArea.appendChild(div);
                });
            }

            function getPolarPath(cx,cy,r,startA,endA){
                // Fix full circle
                if(Math.abs(endA-startA) >= 360) return `M ${cx},${cy-r} A ${r},${r} 0 1 1 ${cx},${cy+r} A ${r},${r} 0 1 1 ${cx},${cy-r} Z`;
                
                const s=polar(cx,cy,r,endA), e=polar(cx,cy,r,startA);
                const large = endA-startA <= 180 ? 0 : 1;
                return `M ${cx},${cy} L ${s.x},${s.y} A ${r},${r} 0 ${large} 0 ${e.x},${e.y} Z`;
            }
            function polar(cx,cy,r,a){
                const rad=(a-90)*Math.PI/180; return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)};
            }

            function showFloatingNumber(container, textToShow, type, isNumerator = false, positionIndex = 0) {
                const floatEl = document.createElement('div');
                floatEl.className = 'floating-count';
                if(isNumerator) floatEl.classList.add('numerator-mode');
                floatEl.textContent = textToShow;
                
                floatEl.style.top = '50%'; floatEl.style.left = '50%';

                const isCircle = (type === 'pizza' || type === 'circle_plain');

                if (isCircle) {
                    const totalParts = parseInt(dom.slider.value);
                    const angleStep = 360 / totalParts;
                    const itemIndex = positionIndex % totalParts; 
                    const midAngle = (itemIndex * angleStep) + (angleStep / 2);
                    const r = 38; 
                    const rad = (midAngle - 90) * Math.PI / 180;
                    const x = 50 + r * Math.cos(rad);
                    const y = 50 + r * Math.sin(rad);
                    floatEl.style.left = x + '%'; floatEl.style.top = y + '%';
                }
                else {
                    const totalParts = parseInt(dom.slider.value);
                    const widthPerPart = 100 / totalParts;
                    const itemIndex = positionIndex % totalParts;
                    const x = (itemIndex * widthPerPart) + (widthPerPart / 2);
                    floatEl.style.left = x + '%';
                }

                container.appendChild(floatEl);
                setTimeout(() => { if(floatEl.parentNode) floatEl.parentNode.removeChild(floatEl); }, 800);
            }

            function createSingleSliceSVG(type, i, totalParts) {
                // Not used in main renderer anymore, but kept for animation logic if needed
                // Consolidated into main renderSVG for consistency
                return null; 
            }

            function setActiveInput(newActive) {
                state.activeInput = newActive;
                Object.values(dom.inputBoxes).forEach(box => box.classList.remove('active'));
                dom.inputBoxes[newActive].classList.add('active');
            }

            function handleNumpad(numStr) {
                let currentVal = state.input[state.activeInput] || '';
                if (currentVal.length >= 3) return;
                
                const tempInput = { ...state.input, [state.activeInput]: currentVal + numStr };
                const n = parseInt(tempInput.numerator);
                const d = parseInt(tempInput.denominator);
                
                if (n && d) {
                    const totalNeeded = Math.ceil(n / d);
                    if (totalNeeded > 10) {
                        showAlert("Maksimal 10 bangun.");
                        return; 
                    }
                }

                state.input[state.activeInput] = currentVal + numStr;
                render();
            }

            function updateInputDisplays() {
                dom.inputBoxes.numerator.textContent = state.input.numerator || '?';
                dom.inputBoxes.denominator.textContent = state.input.denominator || '?';
            }

            function clearInputs() { state.input[state.activeInput] = ''; render(); }
            function showAlert(message) { dom.alertMessage.textContent = message; dom.alertOverlay.classList.remove('hidden'); }
            function checkNumPlayButton() {
                const { numerator, denominator } = state.input;
                dom.playBtnNum.disabled = !(numerator && denominator && parseInt(denominator) > 0);
            }
            function setAnimating(isAnim) {
                if(isAnim) document.body.classList.add('is-animating');
                else document.body.classList.remove('is-animating');
            }

            // --- ANIMATIONS ---
            
            async function animatePictureToNumber() {
                if (state.items.length === 0) return;
                setAnimating(true);
                dom.finalFraction.classList.remove('visible'); 
                
                // 1. Penyebut (Hitung potongan di bangun pertama)
                let denominatorElements = [];
                const firstContainer = document.querySelector('.shape-container');
                if (firstContainer) {
                     denominatorElements = Array.from(firstContainer.querySelectorAll('.interactive-part'));
                }

                dom.finalNum.textContent = "?"; dom.finalDen.textContent = "0";
                dom.finalFraction.classList.add('visible');

                if(firstContainer) firstContainer.classList.add('popup-focus');

                for (let i = 0; i < denominatorElements.length; i++) {
                    const el = denominatorElements[i];
                    el.classList.add('anim-appear-denom'); // Use stroke highlight

                    dom.finalDen.textContent = i + 1;
                    dom.finalDen.classList.add('pop');
                    setTimeout(() => dom.finalDen.classList.remove('pop'), 300);
                    await new Promise(r => setTimeout(r, ANIM_SPEED));
                    el.classList.remove('anim-appear-denom');
                }
                if(firstContainer) firstContainer.classList.remove('popup-focus');

                // 2. Pembilang (Hitung potongan terpilih di semua bangun)
                dom.finalNum.textContent = "0";
                
                const parts = Array.from(document.querySelectorAll('.shape-container .interactive-part'));
                const selectedElements = parts.filter(p => p.dataset.selected === 'true');

                for (let i = 0; i < selectedElements.length; i++) {
                    const el = selectedElements[i];
                    const parent = el.closest('.shape-container');
                    
                    document.querySelectorAll('.shape-container').forEach(c => c.classList.remove('popup-focus'));
                    parent.classList.add('popup-focus');
                    
                    // Highlight logic depends on mode
                    if(state.shape === 'pizza' || state.shape === 'cake') {
                        // Image Mode: Highlight border
                        el.style.stroke = 'var(--anim-num-highlight)';
                        el.style.strokeWidth = '4px';
                    } else {
                        // Plain Mode: Fill color change
                        el.style.fill = 'var(--anim-num-highlight)';
                    }

                    dom.finalNum.textContent = i + 1;
                    dom.finalNum.classList.add('pop');
                    setTimeout(() => dom.finalNum.classList.remove('pop'), 300);
                    await new Promise(r => setTimeout(r, ANIM_SPEED));

                    // Reset style
                    el.style.stroke = ''; el.style.strokeWidth = ''; el.style.fill = '';
                    parent.classList.remove('popup-focus');
                }
                setAnimating(false);
            }

            async function animateNumberToPicture() {
                let n = parseInt(state.input.numerator) || 0;
                let d = parseInt(state.input.denominator) || 2;
                if (d === 0) d = 2;

                setAnimating(true);
                
                let shapesNeeded = Math.ceil(n / d);
                if (shapesNeeded === 0) shapesNeeded = 1;
                let totalSlotsNeed = shapesNeeded * d;
                
                // Prepare Visuals Area (Empty)
                dom.visualsArea.innerHTML = ''; 
                dom.visualsArea.setAttribute('data-count', shapesNeeded);
                dom.visualsArea.classList.remove('grid-layout');
                if(shapesNeeded > 0 && shapesNeeded % 2 === 0) {
                    dom.visualsArea.classList.add('grid-layout');
                    const cols = shapesNeeded / 2;
                    dom.visualsArea.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                    dom.visualsArea.style.gridTemplateRows = `1fr 1fr`;
                } else {
                    dom.visualsArea.style.gridTemplateColumns = '';
                    dom.visualsArea.style.gridTemplateRows = '';
                }

                dom.inputBoxes.denominator.classList.add('highlight-denom');
                dom.slider.value = d; dom.sliderValue.textContent = d;
                state.partsPerShape = d;

                // We need to construct the DOM structure manually for animation
                // This mimics renderShape but builds one by one
                
                // Helper to create basic container
                const createContainer = () => {
                    const div = document.createElement('div');
                    div.className = 'shape-container popup-focus'; // Z-INDEX FIX
                    
                    const svgNS = "http://www.w3.org/2000/svg";
                    const svg = document.createElementNS(svgNS, 'svg');
                    svg.setAttribute('viewBox', '0 0 100 100');
                    svg.classList.add('shape-svg');
                    
                    const defs = document.createElementNS(svgNS, 'defs');
                    svg.appendChild(defs);
                    div.appendChild(svg);
                    dom.visualsArea.appendChild(div);
                    return {div, svg, defs};
                };

                let currentGroup = null;
                let createdElements = [];

                // --- FASE 1: MEMBANGUN PENYEBUT ---
                for(let i=0; i<totalSlotsNeed; i++) {
                    let partIndex = i % d;
                    
                    if (partIndex === 0) {
                        if(currentGroup) currentGroup.div.classList.remove('popup-focus');
                        currentGroup = createContainer();
                    }
                    
                    // Render Logic (Single Slice)
                    const svgNS = "http://www.w3.org/2000/svg";
                    let pathD = "";
                    if (state.shape.includes('circle') || state.shape === 'pizza') {
                        pathD = getPolarPath(50, 50, 48, (360/d)*partIndex, (360/d)*(partIndex+1));
                    } else {
                        const w = 100/d;
                        const x = partIndex * w;
                        pathD = `M ${x},0 L ${x+w},0 L ${x+w},100 L ${x},100 Z`;
                    }

                    const g = document.createElementNS(svgNS, 'g');
                    let targetEl; // Element to animate/color later

                    const isImageMode = (state.shape === 'pizza' || state.shape === 'cake');
                    
                    if (isImageMode) {
                        const clipId = `anim-clip-${i}-${Date.now()}`;
                        const clipPath = document.createElementNS(svgNS, 'clipPath');
                        clipPath.setAttribute('id', clipId);
                        const pathShape = document.createElementNS(svgNS, 'path');
                        pathShape.setAttribute('d', pathD);
                        clipPath.appendChild(pathShape);
                        currentGroup.defs.appendChild(clipPath);

                        const img = document.createElementNS(svgNS, 'image');
                        let u = (state.shape === 'pizza') ? IMG_URLS.pizza : IMG_URLS.cake;
                        img.setAttribute('href', u);
                        
                        if (state.shape === 'pizza') {
                            img.setAttribute('x', '0'); img.setAttribute('y', '-7'); 
                            img.setAttribute('width', '100'); img.setAttribute('height', '115');
                        } else {
                            img.setAttribute('width', '100'); img.setAttribute('height', '100');
                            img.setAttribute('preserveAspectRatio', 'none'); 
                        }
                        
                        img.setAttribute('clip-path', `url(#${clipId})`);
                        img.classList.add('slice-image');
                        img.style.opacity = "0.2"; // Start Empty
                        img.style.filter = "grayscale(100%)";
                        
                        g.appendChild(img);
                        targetEl = img; // We will animate opacity of image
                    } else {
                        const path = document.createElementNS(svgNS, 'path');
                        path.setAttribute('d', pathD);
                        path.setAttribute('fill', '#eee'); // Start Empty
                        path.setAttribute('stroke', '#fff'); 
                        path.setAttribute('stroke-width', '1');
                        g.appendChild(path);
                        targetEl = path; // We will animate fill of path
                    }

                    // Hit Area (for highlighting during count)
                    const hitPath = document.createElementNS(svgNS, 'path');
                    hitPath.setAttribute('d', pathD);
                    hitPath.classList.add('interactive-part');
                    // Special animation class
                    hitPath.classList.add('anim-appear-denom'); 
                    
                    g.appendChild(hitPath);
                    currentGroup.svg.appendChild(g);

                    // Show Number
                    showFloatingNumber(currentGroup.div, (partIndex+1), state.shape, false, partIndex);

                    createdElements.push({ target: targetEl, container: currentGroup.div, hit: hitPath });

                    await new Promise(r => setTimeout(r, ANIM_SPEED));
                    hitPath.classList.remove('anim-appear-denom');
                }
                if(currentGroup) currentGroup.div.classList.remove('popup-focus');
                dom.inputBoxes.denominator.classList.remove('highlight-denom');

                // --- FASE 2: MENGISI PEMBILANG ---
                dom.inputBoxes.numerator.classList.add('highlight-num');
                await new Promise(r => setTimeout(r, 500));

                for(let i=0; i<n; i++) {
                    let obj = createdElements[i];
                    if(!obj) break; 

                    document.querySelectorAll('.shape-container').forEach(c => c.classList.remove('popup-focus'));
                    obj.container.classList.add('popup-focus');
                    
                    // Show Number
                    showFloatingNumber(obj.container, i+1, state.shape, true, i); 

                    // Fill Action
                    const isImageMode = (state.shape === 'pizza' || state.shape === 'cake');
                    if(isImageMode) {
                        obj.target.style.opacity = "1";
                        obj.target.style.filter = "drop-shadow(0 0 1px rgba(0,0,0,0.5))";
                    } else {
                        obj.target.setAttribute('fill', 'var(--selected-yellow)');
                    }
                    
                    // Scale effect
                    obj.target.style.transform = 'scale(1.05)';
                    
                    await new Promise(r => setTimeout(r, ANIM_SPEED)); 
                    
                    obj.target.style.transform = 'scale(1)';
                    obj.container.classList.remove('popup-focus');
                }

                dom.inputBoxes.numerator.classList.remove('highlight-num');

                // State Sync & Final Re-render (to attach proper listeners)
                state.items = [];
                let filledCount = 0;
                for(let s=0; s<shapesNeeded; s++) {
                    let parts = Array(d).fill(false);
                    for(let p=0; p<d; p++) {
                        if(filledCount < n) { parts[p] = true; filledCount++; }
                    }
                    state.items.push({ selections: parts });
                }
                
                renderVisuals(); 
                setAnimating(false);
            }
            
            dom.modeBtns.forEach(btn => btn.addEventListener('click', () => switchMode(btn.dataset.mode)));
            dom.shapeBtns.forEach(btn => btn.addEventListener('click', switchShape));
            dom.addBtn.addEventListener('click', handleAddButton); 
            dom.removeBtn.addEventListener('click', handleRemoveButton);
            dom.slider.addEventListener('input', handleSlider); 
            dom.restartBtn.addEventListener('click', resetState);
            
            dom.playBtnPic.addEventListener('click', animatePictureToNumber);
            dom.playBtnNum.addEventListener('click', animateNumberToPicture);
            dom.alertCloseBtn.addEventListener('click', () => dom.alertOverlay.classList.add('hidden'));
            Object.keys(dom.inputBoxes).forEach(key => dom.inputBoxes[key].addEventListener('click', () => setActiveInput(key)));
            dom.numpadBtns.forEach(btn => { if (!btn.classList.contains('clear')) btn.addEventListener('click', () => handleNumpad(btn.dataset.num)); });
            dom.clearBtn.addEventListener('click', clearInputs); 
            
            init();
        });
    </script>
</body>
</html></textarea>
    <textarea id="storage-app-2" class="raw-storage"><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konsep Pecahan Senilai</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');

        :root {
            --primary-color: #007bff; --dark-blue: #004a99; --light-blue: #f0f7ff;
            --text-color: #333; --base-gray: #e0e0e0; 
            --color-left: #ffca28;  
            --color-right: #26c6da; 
            --success-green: #28a745; --danger-red: #dc3545;
            --btn-action: #ff9800;
            --btn-reset: #607d8b;
        }

        body {
            font-family: 'Nunito', sans-serif; background-color: var(--light-blue);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; color: var(--text-color);
            overflow-x: hidden; touch-action: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            background-color: #ffffff; padding: 20px; border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0, 80, 150, 0.15); width: 95%; max-width: 1000px;
            position: relative;
        }

        h1 { color: var(--dark-blue); font-weight: 800; margin-top: 10px; text-align: center; }

        /* Tombol Restart */
        .restart-btn {
            position: absolute; top: 20px; left: 20px;
            width: 40px; height: 40px; border-radius: 50%;
            background-color: #f8f9fa; border: 2px solid #ddd;
            color: var(--text-color); cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease; z-index: 50;
        }
        .restart-btn:hover { 
            background-color: var(--btn-reset); color: white; border-color: var(--btn-reset);
            transform: rotate(-180deg); 
        }
        .restart-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* Controls */
        .top-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }

        .mode-switcher { display: flex; background-color: #e9ecef; border-radius: 30px; padding: 5px; }
        .mode-btn {
            padding: 8px 15px; border: none; background-color: transparent;
            color: #6c757d; font-size: 0.9em; font-weight: 700;
            border-radius: 25px; cursor: pointer; transition: all 0.3s ease;
        }
        .mode-btn.active { background-color: var(--primary-color); color: white; box-shadow: 0 2px 10px rgba(0, 123, 255, 0.4); }

        /* Shape Selector Styling Update */
        .shape-selector { display: flex; gap: 12px; background: #f8f9fa; padding: 5px 10px; border-radius: 20px; }
        
        .shape-btn {
            width: 50px; height: 50px; border: 3px solid #ddd;
            background: white; cursor: pointer; display: flex; justify-content: center;
            align-items: center; transition: all 0.2s; padding: 0;
            overflow: hidden;
        }
        .shape-btn:hover { transform: scale(1.05); }
        .shape-btn.active { border-color: var(--primary-color); box-shadow: 0 0 8px rgba(0,123,255,0.4); }
        
        /* Specific shapes for buttons */
        .btn-round { border-radius: 50%; }
        .btn-square { border-radius: 8px; }

        .shape-icon-img { width: 100%; height: 100%; object-fit: cover; }
        .shape-icon-svg { width: 28px; height: 28px; fill: var(--dark-blue); }

        /* Workspace */
        .lab-workspace {
            display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;
        }

        .fraction-box {
            flex: 1; background: #f8f9fa; border-radius: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.03); border: 1px solid #eee;
            padding: 15px; display: flex; flex-direction: column; align-items: center;
            min-height: 450px; position: relative; transition: background 0.3s, border-color 0.3s;
            z-index: 1;
        }
        .fraction-box.correct { border: 2px solid var(--success-green); background: #e8f5e9; }
        .fraction-box.wrong { border: 2px solid var(--danger-red); background: #fbe9eb; }

        .box-label { 
            font-weight: 800; color: #fff; margin-bottom: 15px; 
            padding: 5px 15px; border-radius: 15px; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .label-left { background-color: #fdd835; color: #444; } 
        .label-right { background-color: var(--color-right); }

        /* Visual Stage */
        .visual-stage {
            width: 220px; height: 220px; display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px; position: relative; 
            cursor: grab;
            background: transparent; border: none; 
            touch-action: none; 
        }
        .visual-stage:active { cursor: grabbing; }

        .drag-clone {
            position: fixed; pointer-events: none; opacity: 0.75; z-index: 9999; transform-origin: top left;
            background: transparent !important; 
        }

        .shape-svg { 
            width: 100%; height: 100%; overflow: visible; 
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
        }
        
        .interactive-part { cursor: pointer; transition: fill 0.1s; }
        .interactive-part:hover { filter: brightness(0.95); }
        .interactive-part:active { filter: brightness(0.85); }

        .slice-image { transition: opacity 0.2s, filter 0.2s; }
        .hit-area { fill: transparent; stroke: rgba(255,255,255,0.5); stroke-width: 1px; }
        .hit-area:hover { stroke: #fff; stroke-width: 2px; }

        /* Controls */
        .box-controls { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .slider-group { text-align: center; width: 100%; }
        input[type=range] { width: 80%; cursor: pointer; }

        .action-row {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            width: 100%; margin-top: 5px;
        }

        .vertical-fraction {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 800; color: var(--dark-blue);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .v-num, .v-den { font-size: 2.2em; line-height: 1; padding: 2px; }
        .v-line { width: 60px; height: 4px; background-color: #333; margin: 4px 0; border-radius: 2px; }

        .overlay-btn {
            padding: 10px 15px; border-radius: 12px; border: none;
            background-color: var(--btn-action); color: white;
            font-size: 0.9em; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.2s;
            text-align: center; max-width: 80px; line-height: 1.2;
        }
        .overlay-btn:hover { background-color: #f57c00; transform: translateY(-2px); }
        .overlay-btn:active { transform: translateY(0); }

        .input-group-vertical { display: flex; flex-direction: column; align-items: center; }
        .num-input {
            width: 70px; height: 50px; text-align: center; font-size: 1.8em; font-weight: 800;
            border: 2px solid #ccc; border-radius: 10px; outline: none; background: white;
        }
        .num-input:focus { border-color: var(--primary-color); }

        .middle-section {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            align-self: center; gap: 15px; width: 100px;
        }
        .check-btn {
            width: 90px; height: 90px; border-radius: 50%; border: none;
            background: linear-gradient(145deg, var(--primary-color), var(--dark-blue));
            color: white; font-weight: 900; font-size: 1.1em; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .check-btn:active { transform: scale(0.95); }
        .result-display { font-size: 3em; font-weight: 900; min-height: 50px; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .hidden { display: none !important; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        .alert-box {
            background: white; padding: 25px 40px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .alert-box button { margin-top: 15px; padding: 10px 25px; background-color: var(--primary-color); color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }

        @media (max-width: 768px) {
            .lab-workspace { flex-direction: column; }
            .middle-section { flex-direction: row; width: 100%; padding: 10px 0; }
            .check-btn { width: 60px; height: 60px; font-size: 0.9em; }
            .top-controls { justify-content: center; flex-direction: column; }
            h1 { margin-top: 40px; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Tombol Restart -->
        <button class="restart-btn" onclick="fullReset()" title="Ulangi">
            <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        </button>

        <h1>Konsep Pecahan Senilai</h1>
        
        <div class="top-controls">
            <div class="mode-switcher">
                <button class="mode-btn active" data-mode="picture" onclick="setMode('picture')">Gambar ke Angka</button>
                <button class="mode-btn" data-mode="number" onclick="setMode('number')">Angka ke Gambar</button>
            </div>
            
            <div class="shape-selector">
                <!-- 1. PIZZA (Bulat) -->
                <button class="shape-btn btn-round active" data-shape="pizza" onclick="setShape('pizza')" title="Pizza (Lingkaran)">
                    <!-- Pizza 1 as icon -->
                    <img src="https://lh3.googleusercontent.com/d/16UcjLvdl2N7DYerPSSzh4QqUa3nl-oAC" class="shape-icon-img">
                </button>
                <!-- 2. KUE (Kotak) -->
                <button class="shape-btn btn-square" data-shape="cake" onclick="setShape('cake')" title="Kue (Persegi)">
                    <!-- Kue 1 as icon -->
                    <img src="https://lh3.googleusercontent.com/d/1MAanQClTP84BOfsgufk32kjGOQjzKyso" class="shape-icon-img">
                </button>
                <!-- 3. LINGKARAN POLOS -->
                <button class="shape-btn btn-round" data-shape="circle_plain" onclick="setShape('circle_plain')" title="Lingkaran Polos">
                    <svg class="shape-icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                </button>
                <!-- 4. PERSEGI POLOS -->
                <button class="shape-btn btn-square" data-shape="square_plain" onclick="setShape('square_plain')" title="Persegi Polos">
                    <svg class="shape-icon-svg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                </button>
            </div>
        </div>

        <div class="lab-workspace">
            
            <!-- LEFT BOX -->
            <div class="fraction-box" id="box-left">
                <div class="box-label label-left">Pecahan 1</div>
                
                <div class="visual-stage" id="visual-left"></div>
                
                <div class="box-controls">
                    <div class="slider-group pic-control">
                        <label>Potongan: <span id="label-parts-left">2</span></label><br>
                        <input type="range" id="slider-left" min="1" max="16" value="2" oninput="updateFromSlider('left')">
                    </div>
                    
                    <div class="action-row">
                        <div id="btn-container-left">
                            <button class="overlay-btn" onclick="handleSideAction('left')">Lihat Nilai</button>
                        </div>
                        <div id="fraction-display-left" class="pic-control vertical-fraction hidden">
                            <span id="display-num-left" class="v-num">?</span>
                            <div class="v-line"></div>
                            <span id="display-den-left" class="v-den">?</span>
                        </div>
                        <div class="input-group-vertical num-control hidden">
                            <input type="number" id="input-num-left" class="num-input" placeholder="?" oninput="resetToButton('left')">
                            <div class="v-line" style="margin: 5px 0;"></div>
                            <input type="number" id="input-den-left" class="num-input" placeholder="?" oninput="resetToButton('left')">
                        </div>
                    </div>
                </div>
            </div>

            <!-- MIDDLE -->
            <div class="middle-section">
                <button class="check-btn" onclick="checkEquivalence()">
                    CEK
                    <small>Senilai?</small>
                </button>
                <div id="result-icon" class="result-display"></div>
            </div>

            <!-- RIGHT BOX -->
            <div class="fraction-box" id="box-right">
                <div class="box-label label-right">Pecahan 2</div>
                
                <div class="visual-stage" id="visual-right"></div>
                
                <div class="box-controls">
                    <div class="slider-group pic-control">
                        <label>Potongan: <span id="label-parts-right">4</span></label><br>
                        <input type="range" id="slider-right" min="1" max="16" value="4" oninput="updateFromSlider('right')">
                    </div>

                    <div class="action-row">
                        <div id="fraction-display-right" class="pic-control vertical-fraction hidden">
                            <span id="display-num-right" class="v-num">?</span>
                            <div class="v-line"></div>
                            <span id="display-den-right" class="v-den">?</span>
                        </div>
                        <div class="input-group-vertical num-control hidden">
                            <input type="number" id="input-num-right" class="num-input" placeholder="?" oninput="resetToButton('right')">
                            <div class="v-line" style="margin: 5px 0;"></div>
                            <input type="number" id="input-den-right" class="num-input" placeholder="?" oninput="resetToButton('right')">
                        </div>
                        <div id="btn-container-right">
                            <button class="overlay-btn" onclick="handleSideAction('right')">Lihat Nilai</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <div id="alert-overlay" class="overlay hidden">
        <div class="alert-box">
            <h3 id="alert-title">Info</h3><p id="alert-message"></p>
            <button onclick="closeAlert()">Oke</button>
        </div>
    </div>

    <script>
        // STATE
        const state = {
            mode: 'picture',
            shape: 'pizza', // Default
            left: { total: 2, selected: 0, array: [false, false] },
            right: { total: 4, selected: 0, array: [false, false, false, false] }
        };

        // IMAGE ASSETS (UPDATED WITH 4 DIFFERENT IMAGES)
        const IMG_PIZZA_1 = "https://lh3.googleusercontent.com/d/16UcjLvdl2N7DYerPSSzh4QqUa3nl-oAC";
        const IMG_PIZZA_2 = "https://lh3.googleusercontent.com/d/10NMvDhZw5LWgMSVzDW1FHpphY2eMkVQA";
        const IMG_CAKE_1 = "https://lh3.googleusercontent.com/d/1MAanQClTP84BOfsgufk32kjGOQjzKyso";
        const IMG_CAKE_2 = "https://lh3.googleusercontent.com/d/1bYlG2YVd-dpkorkqzZE9jZyi6yL1p3LF";

        let isGlobalDragging = false;

        function init() {
            updateFromSlider('left');
            updateFromSlider('right');
            initGhostDraggable('visual-left');
            initGhostDraggable('visual-right');
        }

        // --- RESET ---
        function fullReset() {
            state.left = { total: 2, selected: 0, array: [false, false] };
            state.right = { total: 4, selected: 0, array: [false, false, false, false] };
            document.getElementById('slider-left').value = 2;
            document.getElementById('slider-right').value = 4;
            document.getElementById('input-num-left').value = '';
            document.getElementById('input-den-left').value = '';
            document.getElementById('input-num-right').value = '';
            document.getElementById('input-den-right').value = '';

            if (state.mode === 'picture') {
                updateFromSlider('left'); updateFromSlider('right');
            } else {
                resetToButton('left'); resetToButton('right');
            }
            resetCheckStatus();
        }

        function setMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');

            if (mode === 'picture') {
                document.querySelectorAll('.pic-control').forEach(el => {
                    if(!el.classList.contains('vertical-fraction')) el.classList.remove('hidden');
                });
                document.querySelectorAll('.num-control').forEach(el => el.classList.add('hidden'));
                resetToButton('left'); resetToButton('right');
                resetVisuals();
            } else {
                document.querySelectorAll('.pic-control').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.num-control').forEach(el => el.classList.remove('hidden'));
                
                document.getElementById('visual-left').innerHTML = `<button class="overlay-btn" onclick="renderFromInputSingle('left')">Buat Gambar</button>`;
                document.getElementById('visual-right').innerHTML = `<button class="overlay-btn" onclick="renderFromInputSingle('right')">Buat Gambar</button>`;
                
                document.getElementById('btn-container-left').classList.add('hidden');
                document.getElementById('btn-container-right').classList.add('hidden');
            }
            resetCheckStatus();
        }

        function setShape(shape) {
            state.shape = shape;
            document.querySelectorAll('.shape-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.shape-btn[data-shape="${shape}"]`).classList.add('active');
            
            if (state.mode === 'picture') {
                renderShape('left'); renderShape('right');
            } else {
                const visL = document.getElementById('visual-left');
                if(!visL.querySelector('button')) renderFromInputSingle('left');
                const visR = document.getElementById('visual-right');
                if(!visR.querySelector('button')) renderFromInputSingle('right');
            }
        }

        function handleSideAction(side) {
            if (state.mode === 'picture') {
                document.getElementById(`display-num-${side}`).textContent = state[side].selected;
                document.getElementById(`display-den-${side}`).textContent = state[side].total;
                document.getElementById(`btn-container-${side}`).classList.add('hidden');
                document.getElementById(`fraction-display-${side}`).classList.remove('hidden');
            }
        }

        // --- CORE LOGIC ---
        function updateFromSlider(side) {
            const slider = document.getElementById(`slider-${side}`);
            const val = parseInt(slider.value);
            state[side].total = val;
            
            const newArray = Array(val).fill(false);
            for(let i=0; i<Math.min(state[side].array.length, val); i++) {
                newArray[i] = state[side].array[i];
            }
            state[side].array = newArray;
            state[side].selected = newArray.filter(Boolean).length;

            document.getElementById(`label-parts-${side}`).textContent = val;
            resetToButton(side);
            renderShape(side);
            resetCheckStatus();
        }

        function toggleSlice(side, index) {
            if (state.mode !== 'picture' || isGlobalDragging) return;

            state[side].array[index] = !state[side].array[index];
            state[side].selected = state[side].array.filter(Boolean).length;
            resetToButton(side); 
            renderShape(side);
            resetCheckStatus();
        }

        function resetToButton(side) {
            if(state.mode === 'picture') {
                document.getElementById(`fraction-display-${side}`).classList.add('hidden');
                const btnContainer = document.getElementById(`btn-container-${side}`);
                btnContainer.classList.remove('hidden');
                btnContainer.innerHTML = `<button class="overlay-btn" onclick="handleSideAction('${side}')">Lihat Nilai</button>`;
            } else {
                const container = document.getElementById(`visual-${side}`);
                if(container.querySelector('svg')) {
                    container.innerHTML = `<button class="overlay-btn" onclick="renderFromInputSingle('${side}')">Buat Gambar</button>`;
                }
            }
        }

        function resetVisuals() { updateFromSlider('left'); updateFromSlider('right'); }

        function renderFromInputSingle(side) {
            const numVal = document.getElementById(`input-num-${side}`).value;
            const denVal = document.getElementById(`input-den-${side}`).value;
            if(numVal === '' || denVal === '') { showAlert("Masukkan angka!"); return; }
            const n = parseInt(numVal) || 0;
            const d = parseInt(denVal) || 1;
            if (d < 1) { showAlert("Penyebut minimal 1"); return; }
            if (n > d) { showAlert("Pembilang tidak boleh lebih besar dari penyebut"); return; }

            state[side].total = d; 
            state[side].selected = n;
            state[side].array = Array(d).fill(false).map((_, i) => i < n);
            renderShape(side);
            resetCheckStatus();
        }

        // --- RENDERER (Supports 4 Images) ---
        function renderShape(side) {
            const container = document.getElementById(`visual-${side}`);
            container.innerHTML = '';
            
            const data = state[side];
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('viewBox', '0 0 100 100');
            svg.classList.add('shape-svg');
            
            // Logic for Geometry & Mode
            const isCircleGeometry = (state.shape === 'pizza' || state.shape === 'circle_plain');
            const isImageMode = (state.shape === 'pizza' || state.shape === 'cake');
            const fillColor = (side === 'left') ? 'var(--color-left)' : 'var(--color-right)';

            // Select specific image based on Side
            let imgUrl = "";
            if (state.shape === 'pizza') {
                imgUrl = (side === 'left') ? IMG_PIZZA_1 : IMG_PIZZA_2;
            } else if (state.shape === 'cake') {
                imgUrl = (side === 'left') ? IMG_CAKE_1 : IMG_CAKE_2;
            }

            const defs = document.createElementNS(svgNS, 'defs');
            svg.appendChild(defs);

            for (let i = 0; i < data.total; i++) {
                // 1. Path Data
                let d = "";
                if (isCircleGeometry) {
                    d = getPathData(50, 50, 48, (360/data.total)*i, (360/data.total)*(i + 1));
                } else {
                    const widthPerPart = 100 / data.total;
                    const x = i * widthPerPart;
                    d = `M ${x},0 L ${x+widthPerPart},0 L ${x+widthPerPart},100 L ${x},100 Z`;
                }

                // 2. Group
                const g = document.createElementNS(svgNS, 'g');

                if (isImageMode) {
                    // MASKING MODE
                    const clipId = `clip-${side}-${i}-${Date.now()}`; 
                    const clipPath = document.createElementNS(svgNS, 'clipPath');
                    clipPath.setAttribute('id', clipId);
                    const pathShape = document.createElementNS(svgNS, 'path');
                    pathShape.setAttribute('d', d);
                    clipPath.appendChild(pathShape);
                    defs.appendChild(clipPath);

                    const img = document.createElementNS(svgNS, 'image');
                    img.setAttribute('href', imgUrl);
                    
                    if (state.shape === 'pizza') {
                        // Centering for Pizza
                        img.setAttribute('x', '0'); img.setAttribute('y', '-7'); 
                        img.setAttribute('width', '100'); img.setAttribute('height', '115');
                    } else {
                        // Stretch for Cake
                        img.setAttribute('width', '100'); img.setAttribute('height', '100');
                        img.setAttribute('preserveAspectRatio', 'none'); 
                    }
                    
                    img.setAttribute('clip-path', `url(#${clipId})`);
                    img.classList.add('slice-image');
                    
                    if (data.array[i]) {
                        img.style.opacity = "1";
                        img.style.filter = "drop-shadow(0 0 1px rgba(0,0,0,0.5))";
                    } else {
                        img.style.opacity = "0.2"; 
                        img.style.filter = "grayscale(100%)";
                    }
                    g.appendChild(img);

                } else {
                    // SOLID MODE
                    const path = document.createElementNS(svgNS, 'path');
                    path.setAttribute('d', d);
                    path.setAttribute('fill', data.array[i] ? fillColor : 'var(--base-gray)');
                    path.setAttribute('stroke', '#fff'); 
                    path.setAttribute('stroke-width', '1');
                    g.appendChild(path);
                }

                // 3. Hit Area
                const hitPath = document.createElementNS(svgNS, 'path');
                hitPath.setAttribute('d', d);
                hitPath.classList.add('interactive-part', 'hit-area');
                if (!isImageMode) hitPath.setAttribute('stroke', 'transparent'); 
                
                hitPath.onclick = () => { toggleSlice(side, i); };

                g.appendChild(hitPath);
                svg.appendChild(g);
            }
            container.appendChild(svg);
        }

        // --- DRAG LOGIC ---
        function initGhostDraggable(elementId) {
            const sourceEl = document.getElementById(elementId);
            let startX, startY;
            let ghostEl = null;

            const onStart = (e) => {
                if (e.target.tagName === 'BUTTON') return;
                if (!sourceEl.querySelector('svg')) return;

                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                startX = clientX;
                startY = clientY;
                isGlobalDragging = false; 

                if (e.type === 'touchstart') {
                    window.addEventListener('touchmove', onMove, {passive: false});
                    window.addEventListener('touchend', onEnd);
                } else {
                    window.addEventListener('mousemove', onMove);
                    window.addEventListener('mouseup', onEnd);
                }
            };

            const onMove = (e) => {
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                
                const dx = clientX - startX;
                const dy = clientY - startY;
                const dist = Math.sqrt(dx*dx + dy*dy);

                if (dist > 10 && !isGlobalDragging) {
                    isGlobalDragging = true;
                    ghostEl = sourceEl.cloneNode(true);
                    ghostEl.classList.add('drag-clone');
                    
                    ghostEl.querySelectorAll('*').forEach(el => el.style.pointerEvents = 'none');

                    const rect = sourceEl.getBoundingClientRect();
                    ghostEl.style.width = rect.width + 'px';
                    ghostEl.style.height = rect.height + 'px';
                    ghostEl.style.left = rect.left + 'px';
                    ghostEl.style.top = rect.top + 'px';
                    ghostEl.removeAttribute('id');
                    
                    document.body.appendChild(ghostEl);
                }

                if (isGlobalDragging && ghostEl) {
                    e.preventDefault(); 
                    ghostEl.style.transform = `translate(${dx}px, ${dy}px)`;
                }
            };

            const onEnd = (e) => {
                if (isGlobalDragging) {
                    if (ghostEl && ghostEl.parentNode) ghostEl.parentNode.removeChild(ghostEl);
                    ghostEl = null;
                    setTimeout(() => { isGlobalDragging = false; }, 50);
                } else {
                    isGlobalDragging = false;
                }

                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseup', onEnd);
                window.removeEventListener('touchmove', onMove);
                window.removeEventListener('touchend', onEnd);
            };

            sourceEl.addEventListener('mousedown', onStart);
            sourceEl.addEventListener('touchstart', onStart, {passive: false});
        }

        // --- CHECKER ---
        function checkEquivalence() {
            if(state.left.total === 0 || state.right.total === 0) return;
            const valLeft = state.left.selected / state.left.total;
            const valRight = state.right.selected / state.right.total;
            const isEquivalent = Math.abs(valLeft - valRight) < 0.000001;
            
            const icon = document.getElementById('result-icon');
            const boxLeft = document.getElementById('box-left');
            const boxRight = document.getElementById('box-right');

            if (isEquivalent) {
                icon.innerHTML = "<span style='color:var(--success-green)'>=</span>";
                boxLeft.classList.add('correct'); boxLeft.classList.remove('wrong');
                boxRight.classList.add('correct'); boxRight.classList.remove('wrong');
            } else {
                icon.innerHTML = "<span style='color:var(--danger-red)'>&ne;</span>";
                boxLeft.classList.add('wrong'); boxLeft.classList.remove('correct');
                boxRight.classList.add('wrong'); boxRight.classList.remove('correct');
            }
        }

        function resetCheckStatus() {
            document.getElementById('result-icon').innerHTML = '';
            document.getElementById('box-left').className = 'fraction-box';
            document.getElementById('box-right').className = 'fraction-box';
        }

        function getPathData(cx,cy,r,startA,endA){const s=polarToCartesian(cx,cy,r,endA),e=polarToCartesian(cx,cy,r,startA);return`M ${cx},${cy} L ${s.x},${s.y} A ${r},${r} 0 ${endA-startA<=180?0:1} 0 ${e.x},${e.y} Z`}
        function polarToCartesian(cx,cy,r,angle){const a=(angle-90)*Math.PI/180;return{x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)}}
        function showAlert(msg) { document.getElementById('alert-message').textContent = msg; document.getElementById('alert-overlay').classList.remove('hidden'); }
        function closeAlert() { document.getElementById('alert-overlay').classList.add('hidden'); }

        init();
    </script>
</body>
</html></textarea>
    <textarea id="storage-app-3" class="raw-storage"><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konsep Perbandingan Pecahan</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            --primary: #4361ee;
            --bg-color: #f0f7ff; 
            --card-bg: #ffffff;
            --text: #2b2d42;
            --color-left: #ffca3a; 
            --color-right: #4cc9f0; 
            --success: #06d6a0;
            --error: #ef476f;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', sans-serif; background-color: var(--bg-color);
            margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start;
            color: var(--text); overflow-x: hidden; padding: 20px;
        }

        /* FRAME UTAMA */
        .app-container {
            background-color: #ffffff; padding: 25px; border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0, 80, 150, 0.15); width: 100%; max-width: 1100px;
            position: relative; display: flex; flex-direction: column; align-items: center;
        }

        /* HEADER */
        h1 { 
            color: #004a99; font-weight: 800; margin-top: 10px; margin-bottom: 25px; 
            text-align: center; font-size: 1.8rem;
        }

        /* Tombol Restart (Kiri Atas) */
        .restart-btn {
            position: absolute; top: 20px; left: 20px;
            width: 45px; height: 45px; border-radius: 50%;
            background-color: #f8f9fa; border: 2px solid #ddd;
            color: #555; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease; z-index: 50;
        }
        .restart-btn:hover { 
            background-color: var(--error); color: white; border-color: var(--error);
            transform: rotate(-180deg); 
        }
        .restart-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* Pilihan Gambar (Kanan Atas) */
        .top-controls {
            position: absolute; top: 20px; right: 20px;
            display: flex; gap: 8px; z-index: 50;
            background: #f8f9fa; padding: 5px; border-radius: 12px; border: 1px solid #eee;
        }
        .shape-btn {
            width: 45px; height: 45px; border: 2px solid #eee;
            background: white; cursor: pointer; display: flex; justify-content: center;
            align-items: center; transition: 0.2s; padding: 0; overflow: hidden;
        }
        .shape-btn:hover { transform: scale(1.05); }
        .shape-btn.active { border-color: var(--primary); box-shadow: 0 0 8px rgba(67, 97, 238, 0.3); }
        
        .btn-round { border-radius: 50%; }
        .btn-square { border-radius: 8px; }
        .shape-icon-img { width: 100%; height: 100%; object-fit: cover; }
        .shape-icon-svg { width: 24px; height: 24px; fill: #004a99; }

        /* STAGE LAYOUT */
        .stage {
            display: flex; justify-content: space-between; align-items: flex-start; 
            gap: 20px; width: 100%; position: relative; margin-top: 20px;
        }

        /* CARD (Panel Kiri/Kanan) */
        .card {
            flex: 1; background: #f8f9fa; border-radius: 20px;
            padding: 20px; display: flex; flex-direction: column; align-items: center;
            border: 2px dashed #ccc; transition: border-color 0.3s, background 0.3s, box-shadow 0.3s;
            min-height: 600px; position: relative;
        }
        
        /* Highlight Winner */
        .card.winner { 
            border: 4px solid var(--success); 
            background: #e8f5e9;
            box-shadow: 0 10px 30px rgba(6, 214, 160, 0.2); 
            z-index: 20; transform: scale(1.02);
        }

        /* INPUTS */
        .fraction-input-group {
            display: flex; flex-direction: column; align-items: center;
            background: white; padding: 10px; border-radius: 15px; 
            border: 1px solid #ddd; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .num-input {
            width: 70px; height: 50px; text-align: center; font-size: 1.8rem; font-weight: 900;
            border: 2px solid #eee; border-radius: 10px; outline: none; background: white; color: var(--text);
        }
        .num-input:focus { border-color: var(--primary); }
        .frac-line-input { width: 60px; height: 4px; background: #333; margin: 5px 0; border-radius: 2px; }

        /* MULTIPLIER (x1, x2) */
        .multiplier-section {
            width: 100%; border: 1px dashed #bbb; border-radius: 15px; padding: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            margin-bottom: 15px; background: rgba(255,255,255,0.5);
        }
        .mult-controls { display: flex; align-items: center; gap: 15px; }
        .circle-btn {
            width: 35px; height: 35px; border-radius: 50%; border: none;
            background: #e0e0e0; color: #555; font-weight: 900; cursor: pointer; font-size: 1.2rem;
            transition: 0.2s;
        }
        .circle-btn:hover { background: var(--primary); color: white; }

        /* MATH DISPLAY */
        .calc-container { display: flex; align-items: center; gap: 5px; font-weight: 800; color: #555; font-size: 1.1rem; }
        .frac-stack { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .math-line { width: 100%; height: 2px; background: #555; margin: 2px 0; }
        .highlight-mult { color: #f72585; }
        .result-stack { color: var(--primary); transform: scale(1.1); font-weight: 900; }

        /* BUTTON GENERATE */
        .btn-generate {
            width: 100%; padding: 12px; border-radius: 12px; border: none;
            background: var(--primary); color: white; font-weight: 800; font-size: 1rem;
            cursor: pointer; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2);
            transition: 0.2s; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-generate:hover { transform: translateY(-2px); background: #2b45d4; }

        /* VISUAL AREA */
        .visual-container {
            width: 220px; height: 220px; display: flex; justify-content: center; align-items: center;
            position: relative; cursor: grab; background: transparent;
        }
        .visual-container:active { cursor: grabbing; }
        .empty-state { color: #aaa; font-style: italic; font-size: 0.9rem; text-align: center; pointer-events: none; }
        
        .shape-svg { 
            width: 100%; height: 100%; overflow: visible; 
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.15)); 
        }
        .slice-image { transition: opacity 0.3s; }

        /* Clone Drag */
        .drag-clone { position: fixed; pointer-events: none; opacity: 0.7; z-index: 9999; transform-origin: top left; }

        /* MIDDLE PANEL (Operator & Check) */
        .middle-panel {
            display: flex; flex-direction: column; align-items: center; gap: 20px; 
            margin-top: 150px; /* Align vertically */
            min-width: 80px;
        }

        .op-group { display: flex; gap: 10px; }
        .op-btn {
            width: 55px; height: 55px; border-radius: 12px; border: 2px solid #eee;
            background: white; font-size: 1.8rem; font-weight: 900; color: #ccc;
            cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center;
        }
        .op-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        /* CSS Kelas untuk tombol terpilih - PENTING */
        .op-btn.selected { 
            background-color: var(--primary) !important; 
            color: white !important; 
            border-color: var(--primary) !important; 
            transform: scale(1.1); 
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); 
        }
        
        .op-btn.correct-answer { background: var(--success); color: white; border-color: var(--success); transform: scale(1.2); }

        .check-btn {
            width: 80px; height: 80px; background: linear-gradient(145deg, #06d6a0, #04b386); color: white;
            font-weight: 900; border: none; border-radius: 50%; font-size: 1.2rem;
            cursor: pointer; box-shadow: 0 5px 15px rgba(6, 214, 160, 0.4);
            transition: 0.2s; display: flex; justify-content: center; align-items: center;
        }
        .check-btn:hover { transform: scale(1.05); }
        .check-btn:active { transform: scale(0.95); }

        /* OVERLAY ANIMATION */
        .comp-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 500;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .comp-overlay.active { opacity: 1; pointer-events: auto; }

        .comp-container { display: flex; align-items: center; gap: 40px; }

        .num-box {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 140px; height: 140px; border-radius: 25px;
            background: white; border: 4px solid #eee; 
            color: var(--text); font-size: 4rem; font-weight: 900;
            transition: all 0.5s;
        }
        .num-box.filled-left { border-color: var(--color-left); color: #e6a800; box-shadow: 0 10px 30px rgba(255, 202, 58, 0.2); }
        .num-box.filled-right { border-color: var(--color-right); color: #0091b5; box-shadow: 0 10px 30px rgba(76, 201, 240, 0.2); }

        .comp-sign {
            font-size: 8rem; font-weight: 900; color: #ccc;
            opacity: 0; transform: scale(0); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .comp-sign.show { opacity: 1; transform: scale(1); }

        .flying-digit {
            position: fixed; z-index: 1000;
            font-size: 2.5rem; font-weight: 900; color: var(--text);
            background: white; padding: 10px 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; justify-content: center; align-items: center;
            transition: all 1s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #2b2d42; color: white; padding: 12px 30px; border-radius: 30px;
            font-weight: bold; transition: transform 0.3s; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @media (max-width: 900px) {
            .stage { flex-direction: column; align-items: center; }
            .card { width: 100%; min-height: auto; }
            .middle-panel { margin-top: 0; flex-direction: row; margin-bottom: 20px; }
            .top-controls { position: relative; top: 0; right: 0; margin-bottom: 10px; justify-content: center; width: 100%; }
            h1 { margin-top: 50px; } 
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Restart Button (Top Left) -->
        <button class="restart-btn" onclick="resetAll()" title="Reset">
            <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        </button>

        <!-- Image Selector (Top Right) -->
        <div class="top-controls">
            <!-- Pizza (Bulat) -->
            <button class="shape-btn btn-round active" onclick="setShape('pizza')" id="btn-pizza" title="Pizza">
                <img src="https://lh3.googleusercontent.com/d/16UcjLvdl2N7DYerPSSzh4QqUa3nl-oAC" class="shape-icon-img">
            </button>
            <!-- Kue (Persegi) -->
            <button class="shape-btn btn-square" onclick="setShape('cake')" id="btn-cake" title="Kue">
                <img src="https://lh3.googleusercontent.com/d/1MAanQClTP84BOfsgufk32kjGOQjzKyso" class="shape-icon-img">
            </button>
            <!-- Lingkaran Polos -->
            <button class="shape-btn btn-round" onclick="setShape('circle_plain')" id="btn-circle_plain" title="Lingkaran Polos">
                <svg class="shape-icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/></svg>
            </button>
            <!-- Persegi Polos -->
            <button class="shape-btn btn-square" onclick="setShape('square_plain')" id="btn-square_plain" title="Persegi Polos">
                <svg class="shape-icon-svg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"/></svg>
            </button>
        </div>

        <h1>Konsep Perbandingan Pecahan</h1>

        <div class="stage">
            
            <!-- KARTU KIRI -->
            <div class="card card-left" id="card-left">
                <div class="fraction-input-group">
                    <input type="number" class="num-input" id="n-left" value="1" oninput="resetVisual('left')">
                    <div class="frac-line-input"></div>
                    <input type="number" class="num-input" id="d-left" value="2" oninput="updateBaseMath('left'); resetVisual('left')">
                </div>

                <div class="multiplier-section">
                    <div class="mult-controls">
                        <button class="circle-btn" onclick="changeMult('left', -1)">-</button>
                        <span id="mult-disp-left" style="font-weight:900; color:var(--primary); font-size:1.1rem;">x1</span>
                        <button class="circle-btn" onclick="changeMult('left', 1)">+</button>
                    </div>
                    <div class="calc-container" id="math-left">
                        <!-- Math populated by JS -->
                    </div>
                </div>

                <button class="btn-generate" onclick="generateImage('left')">Buat Gambar</button>

                <div class="visual-container" id="visual-left">
                    <div class="empty-state">Gambar belum dibuat</div>
                </div>
            </div>

            <!-- PANEL TENGAH (Operator) -->
            <div class="middle-panel" id="middle-panel">
                <div class="op-group" id="op-group">
                    <button class="op-btn" data-val="<" onclick="selectOp('<')">&lt;</button>
                    <button class="op-btn" data-val="=" onclick="selectOp('=')">=</button>
                    <button class="op-btn" data-val=">" onclick="selectOp('>')">&gt;</button>
                </div>
                <button class="check-btn" id="check-btn" onclick="runCheck()">CEK</button>
            </div>

            <!-- KARTU KANAN -->
            <div class="card card-right" id="card-right">
                <div class="fraction-input-group">
                    <input type="number" class="num-input" id="n-right" value="1" oninput="resetVisual('right')">
                    <div class="frac-line-input"></div>
                    <input type="number" class="num-input" id="d-right" value="3" oninput="updateBaseMath('right'); resetVisual('right')">
                </div>

                <div class="multiplier-section">
                    <div class="mult-controls">
                        <button class="circle-btn" onclick="changeMult('right', -1)">-</button>
                        <span id="mult-disp-right" style="font-weight:900; color:var(--primary); font-size:1.1rem;">x1</span>
                        <button class="circle-btn" onclick="changeMult('right', 1)">+</button>
                    </div>
                    <div class="calc-container" id="math-right">
                        <!-- Math populated by JS -->
                    </div>
                </div>

                <button class="btn-generate" onclick="generateImage('right')">Buat Gambar</button>

                <div class="visual-container" id="visual-right">
                    <div class="empty-state">Gambar belum dibuat</div>
                </div>
            </div>

        </div>
    </div>

    <!-- OVERLAY RESULT -->
    <div class="comp-overlay" id="comp-overlay">
        <div class="comp-container">
            <div class="num-box left-box" id="box-num-left"></div>
            <div class="comp-sign" id="comp-sign">=</div>
            <div class="num-box right-box" id="box-num-right"></div>
        </div>
    </div>

    <div id="toast" class="toast">Pesan Error</div>

    <script>
        // --- STATE & ASSETS ---
        const state = {
            shape: 'pizza', // Default
            left: { n: 1, d: 2, m: 1, generated: false },
            right: { n: 1, d: 3, m: 1, generated: false },
            selectedOp: null
        };

        // GAMBAR BERBEDA UNTUK KIRI DAN KANAN
        const IMG_URLS = {
            pizza_left: "https://lh3.googleusercontent.com/d/16UcjLvdl2N7DYerPSSzh4QqUa3nl-oAC", // Pizza 1
            pizza_right: "https://lh3.googleusercontent.com/d/10NMvDhZw5LWgMSVzDW1FHpphY2eMkVQA", // Pizza 2
            cake_left:  "https://lh3.googleusercontent.com/d/1MAanQClTP84BOfsgufk32kjGOQjzKyso",  // Kue 1
            cake_right:  "https://lh3.googleusercontent.com/d/1bYlG2YVd-dpkorkqzZE9jZyi6yL1p3LF"   // Kue 2
        };

        function init() {
            renderMath('left'); renderMath('right');
            initGhostDrag('visual-left'); initGhostDrag('visual-right');
        }

        /* --- LOGIC UTAMA --- */
        
        function setShape(shape) {
            state.shape = shape;
            // Update Active Buttons
            document.querySelectorAll('.shape-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${shape}`).classList.add('active');
            
            // Re-render if generated
            if(state.left.generated) renderSVG('left');
            if(state.right.generated) renderSVG('right');
        }

        function updateBaseMath(side) {
            state[side].m = 1;
            document.getElementById(`mult-disp-${side}`).textContent = 'x1';
            renderMath(side);
        }

        function changeMult(side, delta) {
            let m = state[side].m + delta;
            if (m < 1) m = 1;
            if (m > 10) { showToast("Maksimal x10"); return; }
            
            const curD = parseInt(document.getElementById(`d-${side}`).value) || 1;
            if (curD * m > 36) { showToast("Potongan terlalu banyak!"); return; }

            state[side].m = m;
            document.getElementById(`mult-disp-${side}`).textContent = `x${m}`;
            renderMath(side);
            
            if (state[side].generated) {
                renderSVG(side);
            }
        }

        function renderMath(side) {
            const n = document.getElementById(`n-${side}`).value || 1;
            const d = document.getElementById(`d-${side}`).value || 1;
            const m = state[side].m;
            const resN = n * m;
            const resD = d * m;
            const container = document.getElementById(`math-${side}`);
            
            if (m === 1) {
                container.innerHTML = `
                    <div class="frac-stack result-stack">
                        <span class="math-num source-num-${side}">${n}</span>
                        <div class="math-line"></div>
                        <span class="math-den">${d}</span>
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="frac-stack"><span class="math-num">${n}</span><div class="math-line"></div><span class="math-den">${d}</span></div>
                    <span style="font-size:1rem;color:#888">&times;</span>
                    <div class="frac-stack highlight-mult"><span class="math-num">${m}</span><div class="math-line"></div><span class="math-den">${m}</span></div>
                    <span style="font-size:1rem;color:#888">=</span>
                    <div class="frac-stack result-stack">
                        <span class="math-num source-num-${side}">${resN}</span>
                        <div class="math-line"></div>
                        <span class="math-den">${resD}</span>
                    </div>`;
            }
        }

        function resetVisual(side) {
            state[side].generated = false;
            document.getElementById(`visual-${side}`).innerHTML = '<div class="empty-state">Gambar belum dibuat</div>';
            resetMiddlePanel();
            document.getElementById('card-left').classList.remove('winner');
            document.getElementById('card-right').classList.remove('winner');
        }

        function generateImage(side) {
            const n = document.getElementById(`n-${side}`).value;
            const d = document.getElementById(`d-${side}`).value;
            if(!n || !d) { showToast("Isi angka dulu"); return; }
            if(parseInt(n) > parseInt(d)) { showToast("Pembilang tidak boleh > Penyebut"); return; }

            state[side].n = parseInt(n);
            state[side].d = parseInt(d);
            state[side].generated = true;
            renderSVG(side);
        }

        // --- RENDERER (MASKING & PLAIN) ---
        function renderSVG(side) {
            const container = document.getElementById(`visual-${side}`);
            container.innerHTML = '';
            
            const { n, d, m } = state[side];
            const finalN = n * m;
            const finalD = d * m;
            
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('viewBox', '0 0 100 100');
            svg.classList.add('shape-svg');

            // Determine Geometry & Mode
            const isCircleGeometry = (state.shape === 'pizza' || state.shape === 'circle_plain');
            const isImageMode = (state.shape === 'pizza' || state.shape === 'cake');
            
            // Image Selection
            let imgUrl = "";
            if (state.shape === 'pizza') {
                imgUrl = (side === 'left') ? IMG_URLS.pizza_left : IMG_URLS.pizza_right;
            } else if (state.shape === 'cake') {
                imgUrl = (side === 'left') ? IMG_URLS.cake_left : IMG_URLS.cake_right;
            }

            // Fill Color for Plain Mode
            const fillColor = (side === 'left') ? 'var(--color-left)' : 'var(--color-right)';

            const defs = document.createElementNS(svgNS, 'defs');
            svg.appendChild(defs);

            for (let i = 0; i < finalD; i++) {
                // 1. Path Data
                let pathD = "";
                if (isCircleGeometry) {
                    pathD = getPolarPath(50, 50, 48, (360/finalD)*i, (360/finalD)*(i+1));
                } else {
                    const w = 100/finalD;
                    const x = i * w;
                    pathD = `M ${x},0 L ${x+w},0 L ${x+w},100 L ${x},100 Z`;
                }

                // 2. Group
                const g = document.createElementNS(svgNS, 'g');

                if (isImageMode) {
                    // MASKING MODE
                    const clipId = `clip-${side}-${i}-${Date.now()}`;
                    const clipPath = document.createElementNS(svgNS, 'clipPath');
                    clipPath.setAttribute('id', clipId);
                    const pathShape = document.createElementNS(svgNS, 'path');
                    pathShape.setAttribute('d', pathD);
                    clipPath.appendChild(pathShape);
                    defs.appendChild(clipPath);

                    const img = document.createElementNS(svgNS, 'image');
                    img.setAttribute('href', imgUrl);
                    
                    if (state.shape === 'pizza') {
                        img.setAttribute('x', '0'); img.setAttribute('y', '-7'); 
                        img.setAttribute('width', '100'); img.setAttribute('height', '115');
                    } else {
                        img.setAttribute('width', '100'); img.setAttribute('height', '100');
                        img.setAttribute('preserveAspectRatio', 'none'); 
                    }
                    
                    img.setAttribute('clip-path', `url(#${clipId})`);
                    img.classList.add('slice-image');

                    if (i < finalN) {
                        img.style.opacity = "1";
                        img.style.filter = "drop-shadow(0 0 1px rgba(0,0,0,0.5))";
                    } else {
                        img.style.opacity = "0.2"; 
                        img.style.filter = "grayscale(100%)";
                    }
                    g.appendChild(img);

                } else {
                    // PLAIN MODE
                    const path = document.createElementNS(svgNS, 'path');
                    path.setAttribute('d', pathD);
                    path.setAttribute('fill', i < finalN ? fillColor : '#eee');
                    path.setAttribute('stroke', 'white'); 
                    path.setAttribute('stroke-width', '1');
                    g.appendChild(path);
                }

                // 3. Border Line (Optional visual help for image mode)
                if (isImageMode) {
                    const borderPath = document.createElementNS(svgNS, 'path');
                    borderPath.setAttribute('d', pathD);
                    borderPath.setAttribute('fill', 'none');
                    borderPath.setAttribute('stroke', 'rgba(255,255,255,0.8)');
                    borderPath.setAttribute('stroke-width', '1');
                    g.appendChild(borderPath);
                }

                svg.appendChild(g);
            }
            container.appendChild(svg);
        }

        function getPolarPath(cx,cy,r,startA,endA){
            const s=polar(cx,cy,r,endA), e=polar(cx,cy,r,startA);
            const large = endA-startA <= 180 ? 0 : 1;
            return `M ${cx},${cy} L ${s.x},${s.y} A ${r},${r} 0 ${large} 0 ${e.x},${e.y} Z`;
        }
        function polar(cx,cy,r,a){
            const rad=(a-90)*Math.PI/180; return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)};
        }

        // --- INTERAKSI TANDA & CEK ---

        function selectOp(op) {
            state.selectedOp = op;
            document.querySelectorAll('.op-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.val === op) btn.classList.add('selected');
            });
        }

        function runCheck() {
            if(!state.selectedOp) { showToast("Pilih tanda perbandingan dulu!"); return; }

            const dL = state.left.d * state.left.m;
            const dR = state.right.d * state.right.m;

            if (dL !== dR) { 
                showToast(`Penyebut harus disamakan! (${dL} vs ${dR})`); 
                return; 
            }

            if (!state.left.generated || !state.right.generated) {
                showToast("Buat gambar untuk kedua pecahan!"); return;
            }

            const overlay = document.getElementById('comp-overlay');
            overlay.classList.add('active');
            
            document.getElementById('box-num-left').textContent = '';
            document.getElementById('box-num-right').textContent = '';
            document.getElementById('box-num-left').className = 'num-box';
            document.getElementById('box-num-right').className = 'num-box';
            document.getElementById('comp-sign').classList.remove('show');

            const srcLeft = document.querySelector('.source-num-left');
            const srcRight = document.querySelector('.source-num-right');

            const valL = state.left.n * state.left.m;
            const valR = state.right.n * state.right.m;

            const flyL = createFlyingDigit(valL, srcLeft);
            const flyR = createFlyingDigit(valR, srcRight);

            srcLeft.style.opacity = '0';
            srcRight.style.opacity = '0';

            requestAnimationFrame(() => {
                const boxL = document.getElementById('box-num-left').getBoundingClientRect();
                const boxR = document.getElementById('box-num-right').getBoundingClientRect();

                flyL.style.transform = `translate(${boxL.left + boxL.width/2 - 20}px, ${boxL.top + boxL.height/2 - 20}px) scale(2)`;
                flyR.style.transform = `translate(${boxR.left + boxR.width/2 - 20}px, ${boxR.top + boxR.height/2 - 20}px) scale(2)`;
            });

            setTimeout(() => {
                flyL.remove(); flyR.remove();
                srcLeft.style.opacity = '1'; srcRight.style.opacity = '1';

                const bL = document.getElementById('box-num-left');
                const bR = document.getElementById('box-num-right');
                bL.textContent = valL; bL.classList.add('filled-left');
                bR.textContent = valR; bR.classList.add('filled-right');

                let correctOp = '=';
                if (valL > valR) correctOp = '>'; else if (valL < valR) correctOp = '<';

                const sign = document.getElementById('comp-sign');
                const isCorrect = (state.selectedOp === correctOp);
                
                sign.textContent = correctOp;
                sign.style.color = isCorrect ? 'var(--success)' : 'var(--error)';
                sign.classList.add('show');

                if (valL > valR) {
                    document.getElementById('card-left').classList.add('winner');
                } else if (valL < valR) {
                    document.getElementById('card-right').classList.add('winner');
                }

                showFinalState(correctOp);

                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 2500);

            }, 1000);
        }

        function createFlyingDigit(val, sourceEl) {
            const rect = sourceEl.getBoundingClientRect();
            const el = document.createElement('div');
            el.className = 'flying-digit';
            el.textContent = val;
            el.style.left = '0px'; el.style.top = '0px';
            el.style.transform = `translate(${rect.left}px, ${rect.top}px)`;
            document.body.appendChild(el);
            return el;
        }

        function showFinalState(correctOp) {
            const opGroup = document.getElementById('op-group');
            const checkBtn = document.getElementById('check-btn');
            checkBtn.style.display = 'none';

            opGroup.querySelectorAll('.op-btn').forEach(btn => {
                const btnVal = btn.dataset.val;
                if (btnVal === correctOp) {
                    btn.classList.add('correct-answer');
                    btn.style.background = 'var(--success)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.display = 'none';
                }
            });
        }

        function resetMiddlePanel() {
            const opGroup = document.getElementById('op-group');
            const checkBtn = document.getElementById('check-btn');
            checkBtn.style.display = 'block';
            
            opGroup.querySelectorAll('.op-btn').forEach(btn => {
                btn.classList.remove('selected', 'correct-answer');
                // Remove specific styles applied by correct answer logic
                btn.removeAttribute('style');
            });
            state.selectedOp = null;
        }

        function initGhostDrag(id) {
            const source = document.getElementById(id);
            const start = (e) => {
                if(!source.querySelector('svg')) return;
                e.preventDefault();
                const t = e.touches ? e.touches[0] : e;
                const ghost = source.cloneNode(true);
                ghost.classList.add('drag-clone');
                const r = source.getBoundingClientRect();
                ghost.style.width = r.width+'px'; ghost.style.height = r.height+'px';
                document.body.appendChild(ghost);
                const move = (ev) => {
                    const mt = ev.touches ? ev.touches[0] : ev;
                    ghost.style.transform = `translate(${mt.clientX - r.left - r.width/2}px, ${mt.clientY - r.top - r.height/2}px)`;
                    ghost.style.left = r.left + 'px'; ghost.style.top = r.top + 'px';
                }
                const end = () => {
                    ghost.remove();
                    document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', end);
                    document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end);
                }
                document.addEventListener('mousemove', move); document.addEventListener('mouseup', end);
                document.addEventListener('touchmove', move, {passive:false}); document.addEventListener('touchend', end);
            };
            source.addEventListener('mousedown', start); source.addEventListener('touchstart', start, {passive:false});
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function resetAll() {
            document.querySelectorAll('.num-input').forEach(i => i.value = '');
            state.left = { n: 1, d: 2, m: 1, generated: false };
            state.right = { n: 1, d: 3, m: 1, generated: false };
            document.getElementById('n-left').value = 1; document.getElementById('d-left').value = 2;
            document.getElementById('n-right').value = 1; document.getElementById('d-right').value = 3;
            updateBaseMath('left'); updateBaseMath('right');
            resetVisual('left'); resetVisual('right');
        }

        init();
    </script>
</body>
</html></textarea>
    <textarea id="storage-app-4" class="raw-storage"><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latihan Pecahan Final V4.7</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #06d6a0;
            --error: #ef476f;
            --warning: #ffb703;
            --orange: #fd7e14;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #2b2d42;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 800px; width: 100%; }

        .header {
            background: var(--card); padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
            text-align: center; border-top: 5px solid var(--primary);
        }

        .score-display { font-size: 1.2rem; font-weight: 900; color: var(--primary); margin-bottom: 15px; }

        .nav-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 8px;
            margin-top: 10px;
        }
        .nav-item {
            width: 35px; height: 35px; border-radius: 50%; background: #eee;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.85rem; font-weight: bold; cursor: pointer; color: #777;
            transition: 0.2s; border: 2px solid transparent; position: relative;
        }
        .nav-item:hover { transform: scale(1.1); }
        .nav-item.active { border-color: var(--primary); color: var(--primary); background: white; border-width: 2px; }
        .nav-item.done-correct { background: var(--success); color: white; border-color: var(--success); }
        .nav-item.done-wrong { background: var(--error); color: white; border-color: var(--error); }
        .nav-item.done-partial { background: var(--warning); color: white; border-color: var(--warning); }
        .nav-item.skipped { background: #6c757d; color: white; border-color: #6c757d; }
        .nav-item.skipped-answered { background: var(--orange); color: white; border-color: var(--orange); }
        
        .hint-marker {
            position: absolute; top: -2px; right: -2px; font-size: 10px;
            background: #fff; border-radius: 50%; padding: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .card {
            background: var(--card); padding: 30px; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); min-height: 400px; position: relative;
        }
        .card.locked { pointer-events: none; opacity: 0.9; }
        .card.locked .feedback, .card.locked .footer { pointer-events: auto; opacity: 1; }

        .ind-circle {
            position: absolute; top: 15px; right: 15px;
            width: 30px; height: 30px; border-radius: 50%;
            background: #e0e7ff; color: var(--primary);
            font-size: 0.9rem; font-weight: 900;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid var(--primary);
        }

        .q-number { font-size: 0.9rem; color: #888; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .q-text { font-size: 1.3rem; font-weight: 700; margin-bottom: 25px; line-height: 1.6; padding-right: 40px; }

        .frac { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 5px; font-size: 0.9em; }
        .frac-top { border-bottom: 2px solid currentColor; padding: 0 3px; line-height: 1.1; font-weight: bold; }
        .frac-bot { padding: 0 3px; line-height: 1.1; font-weight: bold; }

        .options-grid { display: grid; gap: 10px; }
        .option-btn {
            padding: 15px; border: 2px solid #eee; border-radius: 10px; background: white;
            cursor: pointer; font-size: 1.1rem; text-align: left; transition: 0.2s; font-weight: 600;
            display: flex; align-items: center;
        }
        .option-btn:hover { border-color: var(--primary); background: #f8f9fa; }
        .option-btn.selected { border-color: var(--primary); background: #e0e7ff; color: var(--primary); }
        .option-btn.key-correct { border-color: var(--success); background: #d1fae5; }
        .option-btn.user-wrong { border-color: var(--error); background: #fee2e2; }

        .drag-area { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        .draggable {
            background: var(--primary); color: white; padding: 10px 20px;
            border-radius: 15px; cursor: grab; font-weight: bold; font-size: 1.1rem;
            display: inline-flex; align-items: center; box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        .drop-zones { display: flex; gap: 15px; justify-content: space-around; }
        .drop-box {
            background: #fafafa; border: 2px dashed #ccc; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: background 0.2s; min-width: 60px;
        }
        .bucket-box { flex: 1; min-height: 150px; padding: 10px; gap: 5px; }
        .bucket-box h4 { margin: 0 0 10px 0; font-size: 0.9rem; color: #777; pointer-events: none; }
        
        .fraction-slot-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap; }
        .fraction-group { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .math-symbol { font-size: 2rem; font-weight: 900; color: #555; margin: 0 10px; }
        
        .slot-box { width: 60px; height: 60px; font-weight: bold; font-size: 1.3rem; color: var(--primary); background: white; justify-content: center; }
        .static-slot { border-style: solid; border-color: #ccc; background: #f9f9f9; color: #333; }
        .slot-box.filled { border-style: solid; border-color: var(--primary); background: #eef2ff; }
        .slot-line { width: 50px; height: 4px; background: #333; margin: 5px 0; border-radius: 2px; }

        .shopping-container { display: flex; align-items: center; justify-content: space-around; width: 100%; gap: 20px; flex-wrap: wrap; }
        .shopping-pair { display: flex; align-items: center; gap: 10px; background: #fdfdfd; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
        .slot-box.wide { width: 100px; font-size: 1.1rem; height: 50px; }

        .input-wrapper { display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 1.3rem; font-weight: bold; flex-wrap: wrap; }
        .text-input {
            border: 2px solid #ccc; border-radius: 8px; padding: 10px; width: 120px;
            text-align: center; font-size: 1.2rem; font-weight: bold;
        }

        .input-vertical { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .input-vertical input { width: 70px; text-align: center; font-size: 1.3rem; font-weight: bold; padding: 8px; border: 2px solid #ccc; border-radius: 8px; }
        .input-line { width: 60px; height: 3px; background: #333; border-radius: 2px; }

        .shading-container { display: flex; justify-content: center; margin: 20px 0; gap: 20px; align-items: center; }
        .slice { fill: #eee; stroke: #555; stroke-width: 1; cursor: pointer; transition: 0.1s; }
        .slice:hover { fill: #ddd; }
        .slice.active { fill: var(--primary); }
        .slice-rect { fill: #eee; stroke: #555; stroke-width: 1; cursor: pointer; }
        .slice-rect.active { fill: var(--primary); }

        .multi_bool_container { background: #f9f9f9; padding: 15px; border-radius: 10px; width: 100%; }
        .bool-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 12px; background: white; border: 1px solid #eee; border-radius: 10px; }
        .bool-opts { display: flex; gap: 10px; }
        .b-btn { padding: 8px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; background: white; color: #555; }
        .b-btn.sel-true, .b-btn.sel-false { background: var(--primary); color: white; border-color: var(--primary); }
        .b-btn.review-correct { background: var(--success) !important; color: white; border-color: var(--success); }

        .footer { margin-top: 30px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 12px 25px; border: none; border-radius: 30px; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .btn-check { background: var(--success); color: white; }
        .btn-skip { background: #6c757d; color: white; }
        .btn-next { background: var(--primary); color: white; display: none; }

        .hint-text { display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 1rem; color: #856404; border-left: 4px solid var(--warning); }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; font-size: 1.1rem; line-height: 1.5; }
        .feedback.correct { background: #d1fae5; color: #065f46; border-left: 5px solid var(--success); }
        .feedback.wrong { background: #fee2e2; color: #991b1b; border-left: 5px solid var(--error); }
        .feedback.partial { background: #fff3cd; color: #856404; border-left: 5px solid var(--warning); }
        .result-screen { text-align: center; display: none; }
        .score-big { font-size: 4rem; font-weight: 900; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Latihan Konsep Pecahan</h1>
        <div class="score-display">Skor Sementara: <span id="current-score">0</span></div>
        <div class="nav-grid" id="nav-grid"></div>
    </div>

    <div class="card" id="quiz-card">
        <div class="ind-circle" id="ind-badge">A</div>
        <div class="q-number" id="q-number">Soal 1</div>
        <div class="q-text" id="q-text">...</div>
        <div id="interaction-area"></div>
        <div class="hint-container">
            <button class="btn btn-hint" onclick="useHint()" id="btn-hint" style="background: #fff3cd; color: #856404; margin-top: 15px;">üí° Bantuan (-2 Poin)</button>
            <div class="hint-text" id="hint-text"></div>
        </div>
        <div class="feedback" id="feedback"></div>
        <div class="footer">
            <button class="btn btn-skip" id="btn-skip" onclick="skipQuestion()">Lewati dulu</button>
            <div>
                <button class="btn btn-check" id="btn-check" onclick="checkAnswer()">Cek Jawaban</button>
                <button class="btn btn-next" id="btn-next" onclick="goToNext()">Lanjut &rarr;</button>
            </div>
        </div>
    </div>

    <div class="card result-screen" id="result-card">
        <h2>Latihan Selesai!</h2>
        <div class="score-big" id="final-score">0</div>
        <p id="final-msg" style="font-weight: bold; margin-top: 10px; color: #555;"></p>
        <p id="diagnostic-msg" style="font-size: 1.1rem; line-height: 1.6; margin: 20px 0; color: #2b2d42;"></p>
        <button class="btn btn-check" onclick="location.reload()">Ulangi Latihan</button>
    </div>
</div>

<script>
    function formatText(text) {
        if (typeof text !== 'string') return text;
        return text.replace(/([0-9a-zA-Z?\[\]]+)\/([0-9a-zA-Z?\[\]]+)/g, function(match, num, den) {
            return `<span class="frac"><span class="frac-top">${num}</span><span class="frac-bot">${den}</span></span>`;
        });
    }

    function shuffleArray(array) {
        let arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    const questions = [
        { type: 'mc', ind: 'A', q: "Dua pecahan dikatakan 'Senilai' apabila...", options: ["Angka pembilang dan penyebutnya sama persis", "Nilai atau besarnya sama meskipun angkanya berbeda", "Jumlah pembilang dan penyebutnya sama", "Pembilangnya lebih besar dari penyebut"], key: 1, hint: "Bayangkan pizza 1/2 dan 2/4. Potongannya beda, tapi kenyangnya sama.", exp: "Senilai berarti nilainya sama walau angka beda. Contoh: 1/2 senilai dengan 2/4 karena 1x2=2 dan 2x2=4." },
        { type: 'bool', ind: 'A', q: "Pecahan 6/8 dan 3/4 memiliki nilai yang berbeda.", key: false, hint: "Samakan penyebutnya lalu bandingkan.", exp: "Salah. Mereka senilai karena 6/8 jika dibagi 2 pada pembilang dan penyebutnya akan menjadi 3/4." },
        { type: 'drag_class', ind: 'B', q: "Kelompokkan pecahan berikut!", items: ["2/6", "3/9", "2/5", "4/10"], buckets: ["Senilai 1/3", "Bukan 1/3"], keys: {"2/6":0, "3/9":0, "2/5":1, "4/10":1}, hint: "1/3 itu kalau dikali 2 jadi 2/6, dikali 3 jadi 3/9.", exp: "2/6 senilai 1/3 (dibagi 2). 3/9 senilai 1/3 (dibagi 3). Sedangkan 2/5 dan 4/10 senilai 2/5 (dibagi 2)." },
        { type: 'drag_class', ind: 'B', q: "Bandingkan dengan angka 1", items: ["3/4", "7/8", "5/4", "3/2"], buckets: ["Kurang dari 1", "Lebih dari 1"], keys: {"3/4":0, "7/8":0, "5/4":1, "3/2":1}, hint: "Perhatikan hubungan antara pembilang (atas) dan penyebut ( bawah).", exp: "Pecahan murni (pembilang < penyebut) bernilai < 1. Pecahan tidak murni (pembilang > penyebut) bernilai > 1." },
        { type: 'mc', ind: 'C', q: "Manakah tanda perbandingan yang tepat untuk: 2/7 ... 4/7 ?", options: ["< (Kurang dari)", "> (Lebih dari)", "= (Sama dengan)", ">= (Lebih sama)"], key: 0, hint: "Jika penyebut sama, lihat pembilangnya.", exp: "Penyebutnya sama (7). Karena pembilang 2 lebih kecil dari 4, maka 2/7 < 4/7." },
        { type: 'drag_slot', subtype: 'compare_custom', ind: 'C', q: "Susun 4 angka ini agar perbandingannya BENAR! ( ... < ... )", items: ["1", "3", "4", "5"], template: "compare", key: "dynamic", hint: "Gunakan perkalian silang untuk mengecek.", exp: "Gunakan perkalian silang (Pembilang A x Penyebut B) untuk memastikan hasil kiri < hasil kanan." },
        { type: 'input', ind: 'C', q: "Tentukan nilai N agar senilai: 3/4 = N/12", key: "9", hint: "4 dikali berapa agar jadi 12?", exp: "Karena penyebut 4 dikali 3 menjadi 12, maka pembilang 3 juga dikali 3 menjadi 9." },
        { type: 'input', ind: 'C', q: "Tentukan nilai N: 2/5 = 4/N", key: "10", hint: "2 dikali berapa agar jadi 4?", exp: "Karena pembilang 2 dikali 2 menjadi 4, maka penyebut 5 juga dikali 2 menjadi 10." },
        { type: 'input', ind: 'C', q: "Isi tanda <, >, atau = untuk: 2/3 ... 4/6", key: "=", hint: "Samakan penyebut ke 6.", exp: "2/3 senilai dengan 4/6 karena 2x2=4 dan 3x2=6. Maka tandanya adalah '='." },
        { type: 'input_vertical', ind: 'C', q: "4/5 senilai dengan", key: "15", hint: "4 dikali berapa agar jadi 12?", exp: "Pembilang 4 dikali 3 menjadi 12, maka penyebut 5 dikali 3 menjadi 15." },
        { type: 'mc', ind: 'D', q: "Manakah pasangan pecahan di bawah ini yang TIDAK senilai?", options: ["1/2 dan 3/6", "2/3 dan 4/6", "3/4 dan 6/8", "1/3 dan 2/5"], key: 3, hint: "Samakan penyebutnya.", exp: "1/3 dan 2/5 tidak senilai. Samakan penyebut ke 15: 1/3 menjadi 5/15 sedangkan 2/5 menjadi 6/15." },
        { type: 'mc', ind: 'D', q: "Contoh perbandingan yang SALAH adalah:", options: ["1/2 > 1/3", "2/5 < 4/5", "3/7 > 5/7", "2/2 = 4/4"], key: 2, hint: "Lihat pembilang jika penyebut sama.", exp: "3/7 > 5/7 salah. Karena penyebut sama (7) dan pembilang 3 lebih kecil dari 5, seharusnya 3/7 < 5/7." },
        { type: 'drag_slot', subtype: 'equal', ind: 'E', q: "Susunlah pecahan senilai dengan 1/2 menggunakan angka yang tersedia! (Pilih 2 angka)", items: ["3", "5", "6", "7"], template: "equal", key: ["3","6"], hint: "Cari angka yang atasnya setengah dari bawahnya.", exp: "3/6 senilai dengan 1/2 karena 3:3=1 dan 6:3=2." },
        { type: 'shading', shape: 'square', ind: 'E', q: "Arsirlah gambar agar bernilai 1/2!", parts: 4, target: 2, hint: "Samakan penyebut ke 4.", exp: "1/2 jika diubah ke per 4 menjadi 2/4 (dikali 2). Jadi arsir 2 dari 4 kotak." },
        { type: 'shading_match', ind: 'E', q: "Arsirlah lingkaran kanan (kosong) agar senilai dengan lingkaran kiri!", refParts: 3, refFill: 2, targetParts: 6, targetKey: 4, hint: "3 kotak kiri menjadi 6 kotak kanan.", exp: "2/3 senilai dengan 4/6 karena 2x2=4 dan 3x2=6." },
        { type: 'shading', shape: 'square', ind: 'E', q: "Arsir persegi ini agar nilainya LEBIH BESAR dari 1/4!", parts: 8, target: [3,4,5,6,7,8], hint: "Samakan penyebut ke 8.", exp: "1/4 senilai dengan 2/8. Agar lebih besar dari 2/8, kamu harus mengarsir 3 kotak atau lebih." },
        { type: 'img_to_frac_locked', ind: 'E', q: "Tentukan pecahan yang nilainya lebih besar dari gambar tersebut", parts: 7, fill: 4, shape: 'circle', fixedVal: 5, hint: "Gunakan penyamaan penyebut ke 35.", exp: "Gambar bernilai 4/7. Jika menjawab N/5, samakan penyebut ke 35: 4/7=20/35. Jika N=3, maka 3/5=21/35. Karena 21 > 20, maka 3/5 lebih besar." },
        { type: 'img_to_frac_locked_num', ind: 'E', q: "Tentukan pecahan yang nilainya lebih kecil dari gambar tersebut", parts: 6, fill: 2, shape: 'square', fixedVal: 2, hint: "Pembilang sama-sama 2.", exp: "Gambar bernilai 2/6. Jika pembilang sama (2), pecahan yang lebih kecil adalah yang penyebutnya lebih besar (misal 2/7 atau 2/8)." },
        { type: 'mc', ind: 'F', q: "Ibu memotong kue menjadi 8 bagian. Adik makan 4 potong. Artinya adik memakan ... bagian kue", options: ["1/4", "1/3", "1/2", "3/4"], key: 2, hint: "Sederhanakan 4/8.", exp: "4/8 disederhanakan menjadi 1/2 (pembilang dan penyebut dibagi 4)." },
        { type: 'drag_slot', subtype: 'shopping', ind: 'F', q: "Ibu membeli: Beras 1/2 kg, Tepung 3/4 kg, Telur 2/5 kg, Gula 2/4 kg. Pasangkan barangnya!", items: ["Beras", "Tepung", "Telur", "Gula"], template: "shopping", hint: "Samakan penyebut ke 20.", exp: "Beras (1/2=10/20) senilai Gula (2/4=10/20). Telur (2/5=8/20) < Tepung (3/4=15/20)." },
        { type: 'bool', ind: 'F', q: "Panjang tali 1/2 meter sama panjangnya dengan 50/100 meter.", key: true, hint: "Samakan penyebutnya.", exp: "Benar. 50/100 jika disederhanakan (dibagi 50) menjadi 1/2." },
        { type: 'mc', ind: 'G', q: "Agar dapat membandingkan dua sisa pizza yang berbeda banyak potongannya dengan mudah, syarat yang paling utama yaitu...", options: ["Menyamakan banyak sisa pizza", "Menyamakan besar potongan pizza", "Mengurangi bentuk pecahan pizza", "Mengalikan bentuk pecahan pizza"], key: 1, hint: "Besar potongan = Penyebut.", exp: "Besar potongan diwakili oleh penyebut. Membandingkan pecahan paling mudah jika penyebutnya sama." },
        { type: 'multi_bool', ind: 'G', q: "Tentukan Benar atau Salah dari dua pernyataan berikut!", items: [{ text: "Jika dua pecahan memiliki pembilang yang sama pasti pecahan tersebut senilai.", key: false }, { text: "Jika dua pecahan memiliki pembilang berbeda dan penyebut sama, pecahan yang lebih kecil adalah yang pembilangnya lebih kecil.", key: true }], hint: "Coba 1/2 dan 1/3.", exp: "1. Salah (1/2 tidak senilai 1/3 walau pembilang sama). 2. Benar (2/5 < 4/5)." },
        { type: 'bool', ind: 'G', q: "Jika pembilang lebih kecil dari penyebut, maka nilai pecahan pasti kurang dari 1.", key: true, hint: "Contoh: 3/4.", exp: "Benar. Selama pembilang < penyebut, kita belum mencapai 'satu bagian utuh'." },
        { type: 'bool', ind: 'G', q: "Untuk menentukan pecahan senilai atau tidak dapat menambahkan atau mengurangkan salah satu atau kedua pecahan.", key: false, hint: "Harus dikali atau dibagi.", exp: "Salah. Pecahan senilai hanya didapat dengan perkalian atau pembagian angka yang sama pada pembilang dan penyebut." }
    ];

    let currentIdx = 0;
    let scoreTotal = 0;
    let userState = new Array(questions.length).fill(null); 
    let shuffledOptionsMap = new Array(questions.length).fill(null);
    let shuffledItemsMap = new Array(questions.length).fill(null);

    function init() {
        questions.forEach((q, idx) => {
            if (q.type === 'mc') shuffledOptionsMap[idx] = shuffleArray(q.options.map((_, i) => i));
            if (q.type.includes('drag')) shuffledItemsMap[idx] = shuffleArray([...q.items]);
        });
        renderNavigator();
        loadQuestion(0);
    }

    function renderNavigator() {
        const grid = document.getElementById('nav-grid');
        grid.innerHTML = '';
        questions.forEach((q, i) => {
            const btn = document.createElement('div');
            btn.className = 'nav-item';
            btn.textContent = i + 1;
            const state = userState[i];
            if(state) {
                if(state.status === 'skipped-answered') btn.classList.add('skipped-answered');
                else if(state.status && state.status !== 'skipped') btn.classList.add(`done-${state.status}`);
                else if(state.status === 'skipped') btn.classList.add('skipped');
                if(state.hintUsed) {
                    const bulb = document.createElement('div');
                    bulb.className = 'hint-marker'; bulb.textContent='üí°'; btn.appendChild(bulb);
                }
            }
            if (i === currentIdx) btn.classList.add('active');
            btn.onclick = () => loadQuestion(i);
            grid.appendChild(btn);
        });
    }

    function loadQuestion(idx) {
        currentIdx = idx;
        renderNavigator();
        const q = questions[idx];
        const area = document.getElementById('interaction-area');
        document.getElementById('q-number').textContent = `Soal No. ${idx + 1}`;
        document.getElementById('q-text').innerHTML = formatText(q.q);
        document.getElementById('ind-badge').textContent = q.ind;
        
        const state = userState[idx] || { status: null, hintUsed: false, userVal: null };
        const isDone = ['correct','wrong','partial'].includes(state.status);
        
        document.getElementById('hint-text').style.display = state.hintUsed ? 'block' : 'none';
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('btn-next').style.display = isDone ? 'inline-block' : 'none';
        document.getElementById('btn-check').style.display = isDone ? 'none' : 'inline-block';
        document.getElementById('btn-skip').style.display = isDone ? 'none' : 'inline-block';
        document.getElementById('quiz-card').className = isDone ? 'card locked' : 'card';

        let html = '';
        if (q.type === 'mc') {
            html = `<div class="options-grid">`;
            shuffledOptionsMap[idx].forEach(realIdx => {
                let cls = 'option-btn' + (state.userVal === realIdx ? ' selected' : '');
                if(isDone) {
                    if(realIdx === q.key) cls += ' key-correct';
                    if(state.userVal === realIdx && state.status !== 'correct') cls += ' user-wrong';
                }
                html += `<div class="${cls}" onclick="selectOption(this, ${realIdx})">${formatText(q.options[realIdx])}</div>`;
            });
            html += `</div>`;
        } else if (q.type === 'bool') {
            let v = state.userVal;
            html = `<div class="options-grid"><div class="option-btn${v===true?' selected':''}${isDone && q.key===true?' key-correct':''}" onclick="selectOption(this, true)">Benar</div><div class="option-btn${v===false?' selected':''}${isDone && q.key===false?' key-correct':''}" onclick="selectOption(this, false)">Salah</div></div>`;
        } else if (q.type.includes('input')) {
            html = `<div class="input-wrapper">`;
            if(q.type==='input_vertical') {
                html += `<div style="display:flex; align-items:center; gap:15px;"><span>4/5 senilai dengan</span><div class="input-vertical"><span>12</span><div class="input-line"></div><input type="text" id="userInput" value="${state.userVal||''}" oninput="saveInputState(${idx}, this.value)"></div></div>`;
            } else {
                html += `<input type="text" class="text-input" id="userInput" value="${state.userVal||''}" oninput="saveInputState(${idx}, this.value)">`;
            }
            html += `</div>`;
        } else if (q.type === 'img_to_frac_locked') {
            html = `<div class="shading-container"><svg width="120" height="120" viewBox="0 0 100 100">`;
            for(let i=0; i<q.parts; i++){
                const startA = (360/q.parts)*i; const endA = (360/q.parts)*(i+1);
                html += `<path d="M50,50 L${polar(50,50,48,endA).x},${polar(50,50,48,endA).y} A48,48 0 0 0 ${polar(50,50,48,startA).x},${polar(50,50,48,startA).y} Z" fill="${i<q.fill?'var(--success)':'#eee'}" stroke="#555"></path>`;
            }
            html += `</svg></div><div class="input-vertical"><input type="number" id="userInput" value="${state.userVal||''}" oninput="saveInputState(${idx}, this.value)"><div class="input-line"></div><span style="font-size:1.5rem; font-weight:bold;">${q.fixedVal}</span></div>`;
        } else if (q.type === 'img_to_frac_locked_num') {
            html = `<div class="shading-container"><svg width="120" height="120" viewBox="0 0 100 100">`;
            const rows = q.parts/2; const ch = 100/rows;
            for(let i=0; i<q.parts; i++){
                html += `<rect x="${(i%2)*50}" y="${Math.floor(i/2)*ch}" width="50" height="${ch}" fill="${i<q.fill?'var(--success)':'#eee'}" stroke="#555"></rect>`;
            }
            html += `</svg></div><div class="input-vertical"><span style="font-size:1.5rem; font-weight:bold;">${q.fixedVal}</span><div class="input-line"></div><input type="number" id="userInput" value="${state.userVal||''}" oninput="saveInputState(${idx}, this.value)"></div>`;
        } else if (q.type === 'shading' || q.type === 'shading_match') {
            let p = q.type==='shading'?q.parts:q.targetParts;
            html = `<div class="shading-container">`;
            if(q.type==='shading_match') {
                html += `<div><svg width="140" height="140" viewBox="0 0 100 100">`;
                for(let i=0; i<q.refParts; i++){
                    const sA = (360/q.refParts)*i; const eA = (360/q.refParts)*(i+1);
                    html += `<path d="M50,50 L${polar(50,50,48,eA).x},${polar(50,50,48,eA).y} A48,48 0 0 0 ${polar(50,50,48,sA).x},${polar(50,50,48,sA).y} Z" fill="${i<q.refFill?'var(--success)':'#eee'}" stroke="#555"></path>`;
                }
                html += `</svg></div><div style="font-size:1.5rem">=</div>`;
            }
            html += `<svg width="140" height="140" viewBox="0 0 100 100" class="shape-svg">`;
            for(let i=0; i<p; i++){
                const isActive = state.userVal && i < state.userVal;
                if(q.shape==='square'){
                    html += `<rect x="${(i%2)*50}" y="${Math.floor(i/2)*(100/(p/2))}" width="50" height="${100/(p/2)}" class="slice-rect${isActive?' active':''}" onclick="toggleSlice(this, ${idx})"></rect>`;
                } else {
                    const sA = (360/p)*i; const eA = (360/p)*(i+1);
                    html += `<path d="M50,50 L${polar(50,50,48,eA).x},${polar(50,50,48,eA).y} A48,48 0 0 0 ${polar(50,50,48,sA).x},${polar(50,50,48,sA).y} Z" class="slice${isActive?' active':''}" onclick="toggleSlice(this, ${idx})"></path>`;
                }
            }
            html += `</svg></div>`;
        } else if (q.type === 'multi_bool') {
            html = `<div class="multi_bool_container">`;
            q.items.forEach((item, rIdx) => {
                let uV = state.userVal ? state.userVal[rIdx] : null;
                let tCls = 'b-btn' + (uV === true ? ' sel-true' : '') + (isDone && item.key === true ? ' review-correct' : '');
                let fCls = 'b-btn' + (uV === false ? ' sel-false' : '') + (isDone && item.key === false ? ' review-correct' : '');
                html += `<div class="bool-row"><span>${item.text}</span><div class="bool-opts"><button class="${tCls}" onclick="setMultiBool(${rIdx}, true, this, ${idx})">Benar</button><button class="${fCls}" onclick="setMultiBool(${rIdx}, false, this, ${idx})">Salah</button></div></div>`;
            });
            html += `</div>`;
        } else if (q.type.includes('drag')) {
            html = `<div class="drag-area">`;
            if(!isDone) shuffledItemsMap[idx].forEach(item => html += `<div class="draggable" draggable="true" id="item-${item}" ondragstart="drag(event)">${formatText(item)}</div>`);
            else html += `<p>(Sudah Dijawab)</p>`;
            html += `</div>`;
            if(q.type==='drag_slot') {
                let v = state.userVal || [];
                html += `<div class="fraction-slot-container">`;
                if(q.subtype==='compare_custom') html += renderSlot(v,0)+`<div class="math-symbol">&lt;</div>`+renderSlot(v,2);
                else if(q.subtype==='equal') {
                    html += `<div class="fraction-group"><div class="drop-box slot-box static-slot">1</div><div class="slot-line"></div><div class="drop-box slot-box static-slot">2</div></div><div class="math-symbol">=</div>` + renderSlot(v,0);
                }
                else if(q.subtype==='shopping') {
                    html += `<div class="shopping-container">
                        <div class="shopping-pair"><div class="drop-box slot-box wide" id="slot-0" ondrop="drop(event)" ondragover="allowDrop(event)">${v[0]||''}</div>= <div class="drop-box slot-box wide" id="slot-1" ondrop="drop(event)" ondragover="allowDrop(event)">${v[1]||''}</div></div>
                        <div class="shopping-pair"><div class="drop-box slot-box wide" id="slot-2" ondrop="drop(event)" ondragover="allowDrop(event)">${v[2]||''}</div>&lt; <div class="drop-box slot-box wide" id="slot-3" ondrop="drop(event)" ondragover="allowDrop(event)">${v[3]||''}</div></div>
                    </div>`;
                }
                html += `</div>`;
            } else {
                html += `<div class="drop-zones">`;
                q.buckets.forEach((b, i) => html += `<div class="drop-box bucket-box" id="zone-${i}" ondrop="drop(event)" ondragover="allowDrop(event)"><h4>${formatText(b)}</h4></div>`);
                html += `</div>`;
            }
        }
        area.innerHTML = html;
        if(isDone) showFeedback(state.status, q.exp, state.score);
    }

    function renderSlot(v, startIdx) {
        return `<div class="fraction-group"><div class="drop-box slot-box" id="slot-${startIdx}" ondrop="drop(event)" ondragover="allowDrop(event)">${v[startIdx]||''}</div><div class="slot-line"></div><div class="drop-box slot-box" id="slot-${startIdx+1}" ondrop="drop(event)" ondragover="allowDrop(event)">${v[startIdx+1]||''}</div></div>`;
    }

    function selectOption(el, val) {
        if(document.getElementById('quiz-card').classList.contains('locked')) return;
        el.parentNode.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        saveStateVal(currentIdx, val);
    }

    function saveInputState(idx, val) {
        if(!userState[idx]) userState[idx] = { status: null, hintUsed: false };
        userState[idx].userVal = val.trim();
    }

    function toggleSlice(el, idx) {
        if(document.getElementById('quiz-card').classList.contains('locked')) return;
        el.classList.toggle('active');
        saveStateVal(idx, document.querySelectorAll('.slice.active, .slice-rect.active').length);
    }

    function setMultiBool(rIdx, val, btn, idx) {
        if(document.getElementById('quiz-card').classList.contains('locked')) return;
        if(!userState[idx]) userState[idx] = { userVal: [null, null] };
        if(!Array.isArray(userState[idx].userVal)) userState[idx].userVal = [null, null];
        userState[idx].userVal[rIdx] = val;
        btn.parentNode.querySelectorAll('.b-btn').forEach(b => b.classList.remove('sel-true', 'sel-false'));
        btn.classList.add(val ? 'sel-true' : 'sel-false');
    }

    function saveStateVal(idx, val) {
        if(!userState[idx]) userState[idx] = { status: null, hintUsed: false };
        userState[idx].userVal = val;
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
    
    function drop(ev) {
        ev.preventDefault();
        if(document.getElementById('quiz-card').classList.contains('locked')) return;
        var data = ev.dataTransfer.getData("text");
        var draggedEl = document.getElementById(data);
        var target = ev.target;
        
        // Perbaikan target deteksi: Pastikan mendapatkan elemen drop-box
        if (!target.classList.contains('drop-box')) {
            target = target.closest('.drop-box');
        }
        
        if (target) {
            const qType = questions[currentIdx].type;
            if (qType === 'drag_class') {
                target.appendChild(draggedEl);
                saveStateVal(currentIdx, "dragged");
            } else if (qType === 'drag_slot') {
                // Gunakan textContent untuk keamanan
                target.textContent = draggedEl.textContent;
                target.classList.add('filled');
                
                if(!userState[currentIdx]) userState[currentIdx] = { userVal: [] };
                if(!Array.isArray(userState[currentIdx].userVal)) userState[currentIdx].userVal = [];
                
                // Ambil index dari ID slot-x
                const slotIndex = parseInt(target.id.split('-')[1]);
                userState[currentIdx].userVal[slotIndex] = draggedEl.textContent;
                
                // Sembunyikan item yang sudah di-drop
                draggedEl.style.display = 'none';
                
                // Simpan status bahwa ada aktivitas drag
                saveStateVal(currentIdx, userState[currentIdx].userVal);
            }
        }
    }

    function polar(cx, cy, r, a) {
        const rad = (a - 90) * Math.PI / 180;
        return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
    }

    function useHint() {
        if (!userState[currentIdx]) userState[currentIdx] = {};
        userState[currentIdx].hintUsed = true;
        document.getElementById('hint-text').style.display = 'block';
        document.getElementById('hint-text').innerHTML = formatText(questions[currentIdx].hint);
        renderNavigator();
    }

    function checkAnswer() {
        const q = questions[currentIdx];
        let isCorrect = false, isPartial = false;
        let state = userState[currentIdx];
        let val = state ? state.userVal : null;

        if (q.type === 'mc' || q.type === 'bool') {
            if (val === null) return alert("Pilih jawaban!");
            isCorrect = (val === q.key);
        } else if (q.type.includes('input')) {
            if (!val) return alert("Isi jawaban!");
            isCorrect = (val.toLowerCase() === q.key.toString().toLowerCase());
        } else if (q.type === 'img_to_frac_locked') {
            if (!val) return alert("Isi angka!");
            isCorrect = (parseInt(val) * q.parts) > (q.fill * q.fixedVal);
        } else if (q.type === 'img_to_frac_locked_num') {
            if (!val) return alert("Isi angka!");
            isCorrect = (parseInt(val) > q.parts);
        } else if (q.type === 'shading' || q.type === 'shading_match') {
            let target = q.target || q.targetKey;
            isCorrect = Array.isArray(target) ? target.includes(val) : (val === target);
        } else if (q.type === 'multi_bool') {
            if(!val || val[0]===null || val[1]===null) return alert("Jawab semua!");
            let c = (val[0]===q.items[0].key?1:0) + (val[1]===q.items[1].key?1:0);
            if(c===2) isCorrect=true; else if(c===1) isPartial=true;
        } else if (q.type === 'drag_class') {
            let c = 0;
            for (const [item, zoneIdx] of Object.entries(q.keys)) {
                if (Array.from(document.getElementById(`zone-${zoneIdx}`).children).some(el => el.textContent === item)) c++;
            }
            isCorrect = (c === q.items.length);
        } else if (q.type === 'drag_slot') {
             if(!val || val.filter(x=>x).length < (q.subtype==='equal'?2:4)) return alert("Lengkapi semua kotak!");
             if (q.subtype === 'compare_custom') isCorrect = (parseInt(val[0])*parseInt(val[3])) < (parseInt(val[2])*parseInt(val[1]));
             else if (q.subtype === 'shopping') {
                 const m = { "Beras": [1,2], "Tepung": [3,4], "Telur": [2,5], "Gula": [2,4] };
                 let v1 = m[val[0]], v2 = m[val[1]], v3 = m[val[2]], v4 = m[val[3]];
                 let p1 = (v1[0]*v2[1] === v2[0]*v1[1]), p2 = (v3[0]*v4[1] < v4[0]*v3[1]);
                 if(p1 && p2) isCorrect=true; else if(p1 || p2) isPartial=true;
             } else isCorrect = (val[0]==q.key[0] && val[1]==q.key[1]);
        }

        let p = isCorrect ? (10 - (state.hintUsed?2:0)) : (isPartial ? 5 : 0);
        state.status = isCorrect ? 'correct' : (isPartial ? 'partial' : 'wrong');
        state.score = p;
        scoreTotal += p;
        document.getElementById('current-score').textContent = scoreTotal;
        showFeedback(state.status, q.exp, p);
        renderNavigator();
        loadQuestion(currentIdx);
    }

    function showFeedback(s, exp, p) {
        const fb = document.getElementById('feedback');
        fb.style.display = 'block'; fb.className = 'feedback ' + s;
        fb.innerHTML = `<strong>${s==='correct'?'BENAR!':s==='partial'?'SEBAGIAN BENAR':'SALAH'} (+${p})</strong><br>${formatText(exp)}`;
    }

    function skipQuestion() {
        if(!userState[currentIdx]) userState[currentIdx] = { status: null, hintUsed: false, userVal: null };
        const val = userState[currentIdx].userVal;
        let hasContent = false;
        if(val !== null && val !== undefined) {
            if(typeof val === 'string' && val.trim() !== "") hasContent = true;
            else if(typeof val === 'number') hasContent = true;
            else if(Array.isArray(val) && val.some(v => v !== null && v !== "")) hasContent = true;
            else if(val === "dragged") hasContent = true;
        }
        userState[currentIdx].status = hasContent ? 'skipped-answered' : 'skipped';
        goToNext();
    }

    function goToNext() {
        let n = currentIdx + 1;
        if (n >= questions.length) {
            const skip = userState.findIndex(s => s && (s.status === 'skipped' || s.status === 'skipped-answered'));
            if (skip !== -1 && confirm("Kembali ke soal yang dilewati?")) loadQuestion(skip);
            else finishQuiz();
        } else loadQuestion(n);
    }

    function finishQuiz() {
        document.getElementById('quiz-card').style.display = 'none';
        document.querySelector('.header').style.display = 'none';
        document.getElementById('result-card').style.display = 'block';
        
        const maxScore = questions.length * 10;
        const finalPercent = Math.round((scoreTotal / maxScore) * 100);
        document.getElementById('final-score').textContent = finalPercent;
        
        let msg = "";
        let diagnostic = "";
        
        if (finalPercent >= 70) {
            if(finalPercent === 100) msg = "Sempurna! Kamu memahami konsep pecahan dengan sangat baik.";
            else msg = "Luar biasa! Kamu sudah menguasai materi ini.";
        } else {
            msg = "Jangan menyerah! Nilaimu masih di bawah 70.";
            let senilaiErr = 0, bandingErr = 0;
            userState.forEach((s, i) => {
                if (!s || s.status !== 'correct') {
                    const ind = questions[i].ind;
                    if (['A', 'B', 'E'].includes(ind)) senilaiErr++;
                    if (['C', 'D', 'F', 'G'].includes(ind)) bandingErr++;
                }
            });
            if (senilaiErr >= bandingErr && senilaiErr > 0) {
                diagnostic = "Silakan pelajari kembali konsep <b>Pecahan Senilai</b>. Ingat bahwa pecahan senilai memiliki nilai yang sama meskipun angkanya berbeda, yang bisa didapat dengan mengali atau membagi pembilang dan penyebut dengan angka yang sama.";
            } else if (bandingErr > senilaiErr) {
                diagnostic = "Silakan pelajari kembali konsep <b>Perbandingan Pecahan</b>. Fokuslah pada cara menyamakan penyebut atau menggunakan perkalian silang untuk menentukan mana pecahan yang lebih besar atau lebih kecil.";
            } else {
                diagnostic = "Silakan pelajari kembali materi pecahan secara keseluruhan, terutama pada bagian yang kamu rasa paling sulit.";
            }
        }
        document.getElementById('final-msg').textContent = msg;
        document.getElementById('diagnostic-msg').innerHTML = diagnostic;
    }

    init();
</script>
</body>
</html></textarea>
    <textarea id="storage-app-5" class="raw-storage"><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balapan Pecahan Dinamis</title>
    <style>
        :root {
            --p1-color: #ff4757;
            --p2-color: #2e86de;
            --road: #3d3d3d;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
            background-color: #f1f2f6;
            overflow: hidden;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* --- PECAHAN VERTIKAL --- */
        .frac {
            display: inline-flex; flex-direction: column;
            vertical-align: middle; text-align: center;
            line-height: 1; margin: 0 4px; font-weight: bold;
        }
        .frac .top { border-bottom: 2px solid #333; padding: 0 2px; }
        .frac .bottom { padding: 2px 2px 0 2px; }

        /* --- ARENA BALAP --- */
        .race-track {
            height: 25vh; background-color: #2ed573;
            position: relative; border-bottom: 5px solid #2f3542;
            display: flex; flex-direction: column; justify-content: space-evenly;
        }

        .lane {
            height: 45px; background-color: var(--road);
            width: 100%; position: relative;
            display: flex; align-items: center;
            border-top: 2px solid #555; border-bottom: 2px solid #555;
        }

        .lane::after {
            content: ''; position: absolute; width: 100%; height: 2px;
            border-top: 2px dashed rgba(255,255,255,0.4); top: 50%;
        }

        .car {
            font-size: 40px; position: absolute;
            left: 5%; /* Posisi Start */
            transform: scaleX(-1); /* Hadap Kanan */
            transition: left 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        .finish-line {
            position: absolute; right: 10%; height: 100%; width: 20px;
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px);
            border-left: 3px solid gold;
        }

        /* --- LAYAR PERMAINAN --- */
        .game-play { height: 75vh; display: flex; }
        .player-side { flex: 1; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; }
        #p1-side { background-color: #fffafa; }
        #p2-side { background-color: #f5fbff; }

        .header { text-align: center; font-size: 16px; padding: 6px; color: white; border-radius: 12px; margin-bottom: 8px; font-weight: bold; }
        .p1-bg { background-color: var(--p1-color); }
        .p2-bg { background-color: var(--p2-color); }

        .question-box {
            background: white; padding: 10px; border-radius: 15px; text-align: center;
            height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 #ddd; margin-bottom: 10px; border: 1px solid #eee;
        }
        .question-text { font-size: 20px; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button {
            padding: 15px 5px; font-size: 22px; border: 1px solid #ccc; border-radius: 12px;
            background: white; cursor: pointer; box-shadow: 0 4px 0 #bbb; transition: 0.1s;
        }
        button:active { transform: translateY(4px); box-shadow: 0 0px 0 #bbb; }

        #win-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100; color: white;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
    </style>
</head>
<body>

    <div id="win-overlay">
        <h1 style="font-size: 80px; margin: 0;">üèÜ</h1>
        <h2 id="win-text" style="font-size: 30px; text-align: center;">MENANG!</h2>
        <button onclick="location.reload()" style="padding: 15px 50px; background:#2ecc71; color:white; border:none; border-radius:10px; font-size: 20px; cursor:pointer;">Main Lagi</button>
    </div>

    <!-- Arena Balap -->
    <div class="race-track">
        <div class="lane">
            <div id="p1-car" class="car">üèéÔ∏è</div>
            <div class="finish-line"></div>
        </div>
        <div class="lane">
            <div id="p2-car" class="car">üöô</div>
            <div class="finish-line"></div>
        </div>
    </div>

    <!-- Kontrol Pemain -->
    <div class="game-play">
        <div id="p1-side" class="player-side">
            <div class="header p1-bg">PEMAIN 1</div>
            <div class="question-box">
                <div id="p1-q" class="question-text"></div>
                <canvas id="p1-canvas" width="70" height="70"></canvas>
            </div>
            <div id="p1-options" class="options-grid"></div>
        </div>
        <div id="p2-side" class="player-side">
            <div class="header p2-bg">PEMAIN 2</div>
            <div class="question-box">
                <div id="p2-q" class="question-text"></div>
                <canvas id="p2-canvas" width="70" height="70"></canvas>
            </div>
            <div id="p2-options" class="options-grid"></div>
        </div>
    </div>

    <script>
        function toFrac(text) {
            return text.replace(/(\d+)\/(\d+)/g, `<div class="frac"><span class="top">$1</span><span class="bottom">$2</span></div>`);
        }

        function drawFraction(canvasId, num, den) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!num) { canvas.style.display = 'none'; return; }
            canvas.style.display = 'block';
            const cx = canvas.width/2, cy = canvas.height/2, r = 30;
            ctx.fillStyle = '#ffde59';
            for(let i=0; i<num; i++){
                ctx.beginPath(); ctx.moveTo(cx,cy);
                ctx.arc(cx,cy,r, (i*2*Math.PI)/den - Math.PI/2, ((i+1)*2*Math.PI)/den - Math.PI/2);
                ctx.closePath(); ctx.fill();
            }
            ctx.strokeStyle='#333'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.stroke();
            for(let i=0; i<den; i++){
                ctx.beginPath(); ctx.moveTo(cx,cy);
                ctx.lineTo(cx+r*Math.cos((i*2*Math.PI)/den-Math.PI/2), cy+r*Math.sin((i*2*Math.PI)/den-Math.PI/2));
                ctx.stroke();
            }
        }

        const questions = [
            { q: "Manakah yang senilai dengan 1/2?", a: ["2/4", "1/3", "2/3", "1/4"], c: "2/4" },
            { q: "Manakah yang senilai dengan 1/3?", a: ["2/6", "1/2", "3/6", "2/3"], c: "2/6" },
            { q: "Berapa nilai gambar di bawah?", a: ["1/4", "1/2", "1/3", "2/3"], c: "1/4", img: [1, 4] },
            { q: "1/2 ... 1/4", a: [">", "<", "=", "‚â†"], c: ">" },
            { q: "Pecahan senilai gambar ini?", a: ["4/8", "1/3", "1/4", "3/4"], c: "4/8", img: [1, 2] },
            { q: "Manakah yang senilai dengan 3/4?", a: ["6/8", "1/2", "3/8", "4/3"], c: "6/8" },
            { q: "1/3 ... 1/2", a: ["<", ">", "=", "‚â†"], c: "<" },
            { q: "Berapa nilai gambar ini?", a: ["3/4", "1/2", "1/4", "2/3"], c: "3/4", img: [3, 4] },
            { q: "Manakah yang senilai dengan 2/5?", a: ["4/10", "2/10", "5/2", "1/5"], c: "4/10" },
            { q: "2/3 ... 1/3", a: [">", "<", "=", "‚â†"], c: ">" },
            { q: "4/8 ... 1/2", a: ["=", ">", "<", "‚â†"], c: "=" },
            { q: "Pecahan senilai gambar ini?", a: ["2/6", "1/2", "2/4", "1/4"], c: "2/6", img: [1, 3] },
            { q: "Manakah yang senilai dengan 3/5?", a: ["6/10", "3/10", "1/5", "9/10"], c: "6/10" },
            { q: "1/5 ... 1/2", a: ["<", ">", "=", "‚â†"], c: "<" },
            { q: "6/12 ... 1/2", a: ["=", ">", "<", "‚â†"], c: "=" },
            { q: "Manakah yang senilai gambar ini?", a: ["2/4", "1/3", "1/5", "2/3"], c: "2/4", img: [2, 4] },
            { q: "3/4 ... 1/2", a: [">", "<", "=", "‚â†"], c: ">" },
            { q: "Manakah yang senilai dengan 1/4?", a: ["2/8", "3/4", "1/2", "3/8"], c: "2/8" },
            { q: "Manakah yang senilai dengan 4/10?", a: ["2/5", "1/2", "1/5", "4/5"], c: "2/5" },
            { q: "2/6 ... 1/3", a: ["=", ">", "<", "‚â†"], c: "=" },
            { q: "Berapa nilai gambar ini?", a: ["2/5", "1/2", "2/3", "3/5"], c: "2/5", img: [2, 5] },
            { q: "7/10 ... 9/10", a: ["<", ">", "=", "‚â†"], c: "<" },
            { q: "Cari yang senilai 1/5!", a: ["2/10", "1/2", "1/3", "2/5"], c: "2/10" },
            { q: "4/7 ... 4/9", a: [">", "<", "=", "‚â†"], c: ">" },
            { q: "Manakah yang senilai dengan 4/12?", a: ["1/3", "1/4", "1/2", "1/5"], c: "1/3" },
            { q: "3/10 ... 7/10", a: ["<", ">", "=", "‚â†"], c: "<" },
            { q: "Pecahan senilai gambar ini?", a: ["2/8", "1/2", "1/3", "3/4"], c: "2/8", img: [1, 4] },
            { q: "3/7 ... 5/7", a: ["<", ">", "=", "‚â†"], c: "<" },
            { q: "Manakah yang senilai dengan 6/8?", a: ["3/4", "1/2", "1/4", "6/10"], c: "3/4" },
            { q: "1/10 ... 1/2", a: ["<", ">", "=", "‚â†"], c: "<" }
        ];

        // LOGIKA BARU: REVERSE RACING
        let pos1 = 0; // Langkah P1
        let pos2 = 0; // Langkah P2
        const WIN_STEP = 4;

        let p1Idx = 0, p2Idx = 0;
        let p1Qs = [], p2Qs = [];

        function init() {
            p1Qs = [...questions].sort(() => Math.random() - 0.5);
            p2Qs = [...questions].sort(() => Math.random() - 0.5);
            render(1); render(2);
            updatePositions();
        }

        function render(p) {
            const data = p === 1 ? p1Qs[p1Idx] : p2Qs[p2Idx];
            document.getElementById(`p${p}-q`).innerHTML = toFrac(data.q);
            drawFraction(`p${p}-canvas`, data.img ? data.img[0] : null, data.img ? data.img[1] : null);
            const grid = document.getElementById(`p${p}-options`);
            grid.innerHTML = '';
            const opts = [...data.a].sort(() => Math.random() - 0.5);
            opts.forEach(opt => {
                const b = document.createElement('button');
                b.innerHTML = toFrac(opt);
                b.onclick = () => check(p, opt, data.c);
                grid.appendChild(b);
            });
        }

        function check(p, chosen, correct) {
            if (chosen === correct) {
                if (p === 1) {
                    // Logika P1 Benar
                    if (pos2 > 0) pos2--; // Dorong mundur P2 dulu
                    else pos1++;        // Baru P1 bisa maju
                } else {
                    // Logika P2 Benar
                    if (pos1 > 0) pos1--; // Dorong mundur P1 dulu
                    else pos2++;        // Baru P2 bisa maju
                }
                updatePositions();
                
                if (pos1 >= WIN_STEP || pos2 >= WIN_STEP) {
                    document.getElementById('win-text').innerText = `PEMAIN ${pos1 >= WIN_STEP ? '1' : '2'} MENANG!`;
                    document.getElementById('win-overlay').style.display = 'flex';
                    return;
                }
            } else {
                document.getElementById(`p${p}-side`).style.animation = "shake 0.3s";
                setTimeout(() => document.getElementById(`p${p}-side`).style.animation = "", 300);
            }
            if (p === 1) p1Idx = (p1Idx + 1) % questions.length;
            else p2Idx = (p2Idx + 1) % questions.length;
            render(p);
        }

        function updatePositions() {
            // Start di 5%, tiap langkah 20%
            document.getElementById('p1-car').style.left = (5 + (pos1 * 20)) + "%";
            document.getElementById('p2-car').style.left = (5 + (pos2 * 20)) + "%";
        }

        init();
    </script>
</body>
</html></textarea>

    <script>
        function showDashboardScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function handleLogin() {
            const name = document.getElementById('user-name').value;
            const token = document.getElementById('user-token').value;
            if (name.trim() === "") { alert("Masukkan nama!"); return; }
            if (token.length !== 6) { alert("Token harus 6 karakter!"); return; }
            showDashboardScreen('screen-menu');
        }

        function openApp(storageId) {
            const viewer = document.getElementById('app-viewer');
            const frame = document.getElementById('app-frame');
            // Mengambil kode dari textarea menggunakan .value (bukan .innerHTML)
            const appCode = document.getElementById(storageId).value;
            
            viewer.style.display = 'block';
            const doc = frame.contentWindow.document;
            doc.open();
            doc.write(appCode);
            doc.close();
        }

        function closeApp() {
            if(confirm("Kembali ke menu utama?")) {
                document.getElementById('app-viewer').style.display = 'none';
                document.getElementById('app-frame').src = "about:blank";
            }
        }
    </script>
</body>
</html>